const r={isRecording:!1,sessionId:null,tabId:null,steps:[]};chrome.runtime.onMessage.addListener((e,s,t)=>{var c,n;switch(e.type){case"content-script:ready":console.log("[QAerx] Content script ready in tab:",(c=s.tab)==null?void 0:c.id),t({success:!0});break;case"recording:started":r.isRecording=!0,r.sessionId=e.sessionId,r.tabId=((n=s.tab)==null?void 0:n.id)||null,r.steps=[],o({type:"recording:state-changed",state:r}),t({success:!0});break;case"recording:stopped":r.isRecording=!1,r.steps=e.steps||[],o({type:"recording:completed",sessionId:e.sessionId,steps:e.steps}),t({success:!0});break;case"recording:step-added":r.steps.push(e.step),o({type:"recording:step-added",step:e.step}),t({success:!0});break;case"recording:paused":case"recording:resumed":o({type:e.type}),t({success:!0});break;case"command:start-recording":return d(e.tabId).then(t),!0;case"command:stop-recording":return u().then(t),!0;case"command:get-state":t({state:r});break;default:t({error:"Unknown message type"})}return!0});function i(e){return["chrome://","chrome-extension://","edge://","about:","data:","file://","view-source:"].some(t=>e.startsWith(t))}async function a(e){try{const s=await chrome.tabs.get(e);if(!s.url||i(s.url))return{success:!1,error:"Cannot record on this page. Please navigate to a regular web page (http:// or https://)."};try{return await chrome.tabs.sendMessage(e,{type:"ping"}),console.log("[QAerx] Content script already loaded"),{success:!0}}catch{console.log("[QAerx] Injecting content script...")}await chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]});for(let t=0;t<3;t++){await new Promise(c=>setTimeout(c,300));try{return await chrome.tabs.sendMessage(e,{type:"ping"}),console.log("[QAerx] Content script injected successfully"),{success:!0}}catch{console.log(`[QAerx] Ping attempt ${t+1} failed, retrying...`)}}return{success:!1,error:"Content script failed to load. Try refreshing the page."}}catch(s){return console.error("[QAerx] Failed to inject content script:",s),{success:!1,error:"Failed to access tab. Make sure you are on a regular web page."}}}async function d(e){try{const s=e||await l();if(!s)return{success:!1,error:"No active tab found"};const t=await a(s);if(!t.success)return{success:!1,error:t.error};const c=crypto.randomUUID();return await chrome.tabs.sendMessage(s,{type:"recording:start",sessionId:c}),r.tabId=s,r.isRecording=!0,r.sessionId=c,r.steps=[],{success:!0}}catch(s){return console.error("[QAerx] Failed to start recording:",s),{success:!1,error:"Failed to start recording. Try refreshing the page."}}}async function u(){try{if(!r.tabId)return{success:!1,error:"No recording in progress"};if(!(await a(r.tabId)).success){const t=r.steps;return r.isRecording=!1,{success:!0,steps:t,error:"Recording stopped but page was reloaded. Some steps may be missing."}}const s=await chrome.tabs.sendMessage(r.tabId,{type:"recording:stop"});return r.isRecording=!1,{success:!0,steps:s.steps}}catch(e){return console.error("[QAerx] Failed to stop recording:",e),r.isRecording=!1,{success:!0,steps:r.steps,error:"Recording stopped with errors."}}}async function l(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e==null?void 0:e.id}function o(e){chrome.runtime.sendMessage(e).catch(()=>{})}chrome.action.onClicked.addListener(e=>{e.id&&chrome.sidePanel.open({tabId:e.id})});chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0});console.log("[QAerx] Background service worker initialized");
