var Ge=Object.defineProperty;var Ke=(n,s,t)=>s in n?Ge(n,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[s]=t;var K=(n,s,t)=>Ke(n,typeof s!="symbol"?s+"":s,t);import"./chunks/modulepreload-polyfill.B5Qt9EMX.js";import{j as e,Z as Ye,F as Je,P as ye,H as Ee,S as Qe,c as z,r as v,z as y,D as He,v as be,C as ke,a as Xe,X as we,b as De,d as Ze,e as Ce,f as ve,T as ee,g as Ae,h as ue,G as et,E as Se,i as Re,k as tt,l as de,m as me,n as pe,L as ne,o as st,N as Pe,M as je,p as Le,q as Me,s as Ne,t as at,u as he,U as rt,w as ze,B as $e,x as nt,y as Oe,A as it,I as ct,J as Ue,K as ot,O as Ie,Q as lt,R as dt,V as le,W as ut,Y as mt,_ as ht,$ as pt,a0 as xt,a1 as gt,a2 as ft,a3 as yt,a4 as bt,a5 as wt,a6 as vt}from"./chunks/client.DFK1FPSC.js";const St=[{id:"suites",icon:Je,label:"Suites"},{id:"tests",icon:ye,label:"Tests"},{id:"results",icon:Ee,label:"Results"},{id:"settings",icon:Qe,label:"Settings"}];function jt({currentView:n,onViewChange:s}){return e.jsxs("aside",{className:"w-16 bg-dark-950 border-r border-dark-800 flex flex-col items-center py-4",children:[e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"w-10 h-10 bg-accent rounded-xl flex items-center justify-center",children:e.jsx(Ye,{className:"w-6 h-6 text-white"})})}),e.jsx("nav",{className:"flex-1 flex flex-col gap-2",children:St.map(t=>{const i=t.icon,a=n===t.id;return e.jsx("button",{onClick:()=>s(t.id),className:z("w-10 h-10 rounded-lg flex items-center justify-center transition-colors",a?"bg-accent text-white":"text-dark-400 hover:text-dark-100 hover:bg-dark-800"),title:t.label,children:e.jsx(i,{className:"w-5 h-5"})},t.id)})}),e.jsx("div",{className:"mt-auto pt-4 text-[10px] text-dark-600",children:"v0.1"})]})}function Nt(){const[n,s]=v.useState({isRecording:!1,isPaused:!1,steps:[],sessionId:null});v.useEffect(()=>{const r=d=>{switch(d.type){case"recording:state-changed":break;case"recording:step-added":d.step&&s(o=>({...o,steps:[...o.steps,d.step]}));break;case"recording:completed":s(o=>({...o,isRecording:!1,steps:d.steps||o.steps}));break;case"recording:paused":s(o=>({...o,isPaused:!0}));break;case"recording:resumed":s(o=>({...o,isPaused:!1}));break}};return chrome.runtime.onMessage.addListener(r),()=>chrome.runtime.onMessage.removeListener(r)},[]);const t=v.useCallback(async()=>{try{const r=await chrome.runtime.sendMessage({type:"command:start-recording"});r.success?(s({isRecording:!0,isPaused:!1,steps:[],sessionId:crypto.randomUUID()}),y.success("Recording started")):y.error(r.error||"Failed to start recording")}catch(r){console.error("Failed to start recording:",r),y.error("Failed to start recording. Make sure you are on a web page.")}},[]),i=v.useCallback(async()=>{var r;try{const d=await chrome.runtime.sendMessage({type:"command:stop-recording"});return d.success?(s(o=>({...o,isRecording:!1,steps:d.steps||o.steps})),y.success(`Recording stopped. ${((r=d.steps)==null?void 0:r.length)||0} steps captured.`),d.steps||[]):(y.error(d.error||"Failed to stop recording"),[])}catch(d){return console.error("Failed to stop recording:",d),y.error("Failed to stop recording"),[]}},[]),a=v.useCallback(async()=>{await chrome.runtime.sendMessage({type:"command:pause-recording"}),s(r=>({...r,isPaused:!0}))},[]),c=v.useCallback(async()=>{await chrome.runtime.sendMessage({type:"command:resume-recording"}),s(r=>({...r,isPaused:!1}))},[]);return{...n,startRecording:t,stopRecording:i,pauseRecording:a,resumeRecording:c}}class kt extends He{constructor(){super("QAerxDB");K(this,"suites");K(this,"tests");K(this,"testRuns");K(this,"credentials");K(this,"screenshots");K(this,"settings");this.version(1).stores({suites:"id, parentId, name, updatedAt",tests:"id, suiteId, name, updatedAt, [suiteId+order]",testRuns:"id, testId, suiteId, status, startedAt, [testId+startedAt]",credentials:"id, name, domain",screenshots:"id, testRunId, stepId, timestamp, isBaseline, [testId+isBaseline]",settings:"id"}),this.version(2).stores({suites:"id, parentId, name, order, updatedAt",tests:"id, suiteId, name, updatedAt, [suiteId+order]",testRuns:"id, testId, suiteId, status, startedAt, [testId+startedAt]",credentials:"id, name, domain",screenshots:"id, testRunId, stepId, timestamp, isBaseline, [testId+isBaseline]",settings:"id"})}}const I=new kt,ie={async create(n){console.log("SuiteRepository.create called with:",n);const s=Date.now(),t={...n,id:be(),createdAt:s,updatedAt:s};return console.log("Creating suite:",t),console.log("Database instance:",I),await I.suites.add(t),console.log("Suite added successfully"),t},async getById(n){return I.suites.get(n)},async getAll(){return I.suites.orderBy("order").toArray()},async getByParent(n){return n===void 0?I.suites.filter(s=>!s.parentId).toArray():I.suites.where("parentId").equals(n).toArray()},async update(n,s){await I.suites.update(n,{...s,updatedAt:Date.now()})},async delete(n){await I.tests.where("suiteId").equals(n).delete();const s=await this.getByParent(n);for(const t of s)await this.delete(t.id);await I.suites.delete(n)},async getTree(){const n=await this.getAll(),s=await I.tests.toArray(),t=new Map;for(const a of s)t.set(a.suiteId,(t.get(a.suiteId)||0)+1);const i=a=>n.filter(c=>c.parentId===a).sort((c,r)=>c.order-r.order).map(c=>({...c,children:i(c.id),tests:t.get(c.id)||0}));return i(void 0)},async createDefault(){return this.create({name:"Default Suite",order:0,hooks:{}})}},Y={async create(n){const s=Date.now(),t={...n,id:be(),createdAt:s,updatedAt:s};return await I.tests.add(t),t},async getById(n){return I.tests.get(n)},async getAll(){return I.tests.toArray()},async getBySuite(n){return I.tests.where("suiteId").equals(n).sortBy("order")},async update(n,s){await I.tests.update(n,{...s,updatedAt:Date.now()})},async delete(n){await I.testRuns.where("testId").equals(n).delete(),await I.tests.delete(n)},async addStep(n,s){const t=await this.getById(n);if(!t)throw new Error("Test not found");const i=[...t.steps,s];await this.update(n,{steps:i})},async updateStep(n,s,t){const i=await this.getById(n);if(!i)throw new Error("Test not found");const a=i.steps.map(c=>c.id===s?{...c,...t}:c);await this.update(n,{steps:a})},async deleteStep(n,s){const t=await this.getById(n);if(!t)throw new Error("Test not found");const a=t.steps.filter(c=>c.id!==s).map((c,r)=>({...c,order:r}));await this.update(n,{steps:a})},async reorderSteps(n,s){const t=await this.getById(n);if(!t)throw new Error("Test not found");const i=new Map(t.steps.map(c=>[c.id,c])),a=s.map((c,r)=>{const d=i.get(c);return d?{...d,order:r}:null}).filter(c=>c!==null);await this.update(n,{steps:a})},async createNew(n,s,t){const a=(await this.getBySuite(n)).length;return this.create({suiteId:n,name:s,url:t,order:a,steps:[]})}},Ct={async create(n,s){const t={id:be(),testId:n,suiteId:s,startedAt:Date.now(),status:"running",environment:await this.getEnvironment(),stepResults:[],summary:{totalSteps:0,passedSteps:0,failedSteps:0,skippedSteps:0,duration:0}};return await I.testRuns.add(t),t},async getById(n){return I.testRuns.get(n)},async getByTest(n,s=10){return I.testRuns.where("testId").equals(n).reverse().sortBy("startedAt").then(t=>t.slice(0,s))},async getBySuite(n,s=50){return I.testRuns.where("suiteId").equals(n).reverse().sortBy("startedAt").then(t=>t.slice(0,s))},async getRecent(n=20){return I.testRuns.orderBy("startedAt").reverse().limit(n).toArray()},async update(n,s){await I.testRuns.update(n,s)},async addStepResult(n,s){const t=await this.getById(n);if(!t)throw new Error("Test run not found");const i=[...t.stepResults,s],a=this.calculateSummary(i,t.startedAt);await this.update(n,{stepResults:i,summary:a})},async complete(n,s){const t=await this.getById(n);if(!t)throw new Error("Test run not found");const i=Date.now(),a=this.calculateSummary(t.stepResults,t.startedAt,i);await this.update(n,{status:s,completedAt:i,summary:a})},async delete(n){await I.screenshots.where("testRunId").equals(n).delete(),await I.testRuns.delete(n)},async pruneOld(n=30){const s=Date.now()-n*24*60*60*1e3,t=await I.testRuns.where("startedAt").below(s).toArray();for(const i of t)await I.screenshots.where("testRunId").equals(i.id).delete();return I.testRuns.where("startedAt").below(s).delete()},calculateSummary(n,s,t){return{totalSteps:n.length,passedSteps:n.filter(i=>i.status==="passed").length,failedSteps:n.filter(i=>i.status==="failed").length,skippedSteps:n.filter(i=>i.status==="skipped").length,duration:(t||Date.now())-s}},async getEnvironment(){var n,s,t,i;return{browserVersion:((n=navigator.userAgent.match(/Chrome\/(\d+)/))==null?void 0:n[1])||"unknown",extensionVersion:((i=(t=(s=chrome.runtime)==null?void 0:s.getManifest)==null?void 0:t.call(s))==null?void 0:i.version)||"0.1.0",screenSize:{width:window.screen.width,height:window.screen.height},userAgent:navigator.userAgent}}},Te={id:"app-settings",parallelLimit:2,defaultTimeout:3e4,screenshotQuality:80,recordMouseMovements:!1,recordScrollEvents:!0,onboardingCompleted:!1,tutorialProgress:0,theme:"dark"},ce={async get(){const n=await I.settings.get("app-settings");return n||(await I.settings.add(Te),Te)},async update(n){const t={...await this.get(),...n};return await I.settings.put(t),t},async setOpenAIKey(n){await this.update({openaiApiKey:n})},async clearOpenAIKey(){await this.update({openaiApiKey:void 0})},async setParallelLimit(n){await this.update({parallelLimit:Math.max(1,Math.min(n,10))})},async completeOnboarding(){await this.update({onboardingCompleted:!0})},async updateTutorialProgress(n){await this.update({tutorialProgress:n})},async setLastOpened(n,s){await this.update({lastOpenedSuiteId:n,lastOpenedTestId:s})}},At={suites:"Test Suites",tests:"Tests",results:"Results",settings:"Settings"};function $t({currentView:n,selectedTestId:s,onRecordingComplete:t}){const{isRecording:i,steps:a,startRecording:c,stopRecording:r}=Nt(),[d,o]=v.useState(!1),[m,p]=v.useState([]),x=async()=>{await c()},f=async()=>{const u=await r();u&&u.length>0?(p(u),o(!0)):y.error("No steps were recorded")},l=async()=>{if(!s){y.error("No test selected. Please select a test first.");return}try{const u=await Y.getById(s);if(u){const w=[...u.steps||[],...m];await Y.update(s,{steps:w}),y.success(`Added ${m.length} steps to test`),t==null||t(m)}}catch{y.error("Failed to save recording")}o(!1),p([])},h=()=>{o(!1),p([]),y.success("Recording discarded")};return e.jsxs(e.Fragment,{children:[e.jsxs("header",{className:"h-14 bg-dark-850 border-b border-dark-800 px-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-lg font-semibold text-dark-100",children:At[n]}),i&&e.jsxs("span",{className:"flex items-center gap-1.5 px-2 py-0.5 bg-red-500/20 text-red-400 rounded-full text-xs animate-pulse",children:[e.jsx(ke,{className:"w-2 h-2 fill-current"}),"Recording (",a.length," steps)"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:i?e.jsxs("button",{onClick:f,className:"btn btn-sm bg-red-600 hover:bg-red-700 text-white",children:[e.jsx(Xe,{className:"w-3 h-3 fill-current"}),"Stop Recording"]}):e.jsxs("button",{onClick:x,className:"btn btn-sm btn-primary",children:[e.jsx(ke,{className:z("w-3 h-3",i&&"fill-current animate-pulse")}),"Record"]})})]}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-dark-800 rounded-xl shadow-2xl w-full max-w-md mx-4 border border-dark-700",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-dark-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-dark-100",children:"Save Recording"}),e.jsx("button",{onClick:h,className:"p-1 hover:bg-dark-700 rounded",children:e.jsx(we,{className:"w-5 h-5 text-dark-400"})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("p",{className:"text-dark-300",children:["Recorded ",e.jsx("span",{className:"font-semibold text-accent",children:m.length})," steps. What would you like to do?"]}),e.jsxs("div",{className:"max-h-40 overflow-auto bg-dark-850 rounded-lg p-2 space-y-1",children:[m.slice(0,5).map((u,w)=>e.jsxs("div",{className:"text-sm text-dark-400 flex items-center gap-2",children:[e.jsxs("span",{className:"text-dark-500 w-4",children:[w+1,"."]}),e.jsx("span",{children:u.name})]},u.id)),m.length>5&&e.jsxs("div",{className:"text-xs text-dark-500 text-center pt-1",children:["+",m.length-5," more steps"]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[s&&e.jsxs("button",{onClick:l,className:"btn btn-primary w-full justify-center",children:[e.jsx(De,{className:"w-4 h-4"}),"Add to Current Test"]}),e.jsx("button",{onClick:h,className:"btn btn-ghost w-full justify-center text-dark-400",children:"Discard Recording"})]}),!s&&e.jsx("p",{className:"text-xs text-dark-500 text-center",children:"Select a test first to save recording, or discard and create steps manually."})]})]})})]})}const Be=v.createContext(null);function It({children:n}){const[s,t]=v.useState([]),[i,a]=v.useState([]),[c,r]=v.useState(null),[d,o]=v.useState(!0),m=async()=>{const f=await ie.getAll();t(f)},p=async f=>{const l=f?await Y.getBySuite(f):await Y.getAll();a(l)},x=async()=>{const f=await ce.get();r(f)};return v.useEffect(()=>{(async()=>{try{console.log("AppContext init starting..."),o(!0),await Promise.all([m(),p(),x()]),console.log("Initial data loaded");const l=await ie.getAll();console.log("All suites:",l),l.length===0&&(console.log("Creating default suite..."),await ie.createDefault(),await m()),o(!1),console.log("AppContext init complete")}catch(l){console.error("AppContext init error:",l),o(!1)}})()},[]),e.jsx(Be.Provider,{value:{suites:s,tests:i,settings:c,isLoading:d,refreshSuites:m,refreshTests:p,refreshSettings:x},children:n})}function We(){const n=v.useContext(Be);if(!n)throw new Error("useApp must be used within AppProvider");return n}function Tt({selectedSuiteId:n,onSelectSuite:s}){const{suites:t,refreshSuites:i}=We(),[a,c]=v.useState(!1),[r,d]=v.useState(""),o=async()=>{if(r.trim())try{await ie.create({name:r.trim(),order:t.length,hooks:{}}),await i(),d(""),c(!1),y.success("Suite created")}catch(p){console.error("Suite creation error:",p),y.error("Failed to create suite: "+(p instanceof Error?p.message:"Unknown error"))}},m=async p=>{if(confirm("Delete this suite and all its tests?"))try{await ie.delete(p),await i(),n===p&&s(null),y.success("Suite deleted")}catch{y.error("Failed to delete suite")}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-sm font-medium text-dark-400 uppercase tracking-wider",children:["Suites (",t.length,")"]}),e.jsxs("button",{onClick:()=>c(!0),className:"btn btn-sm btn-ghost",children:[e.jsx(Ze,{className:"w-4 h-4"}),"New Suite"]})]}),a&&e.jsxs("div",{className:"card p-3",children:[e.jsx("input",{type:"text",placeholder:"Suite name",value:r,onChange:p=>d(p.target.value),onKeyDown:p=>{p.key==="Enter"&&o(),p.key==="Escape"&&c(!1)},className:"input mb-2",autoFocus:!0}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:o,className:"btn btn-sm btn-primary",children:"Create"}),e.jsx("button",{onClick:()=>c(!1),className:"btn btn-sm btn-ghost",children:"Cancel"})]})]}),e.jsxs("div",{className:"space-y-1",children:[t.map(p=>e.jsxs("div",{className:z("group flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-colors",n===p.id?"bg-accent/20 text-accent":"hover:bg-dark-800 text-dark-200"),onClick:()=>s(p.id),children:[e.jsx(Ce,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"flex-1 truncate",children:p.name}),e.jsx(ve,{className:"w-4 h-4 opacity-0 group-hover:opacity-100"}),e.jsx("button",{onClick:x=>{x.stopPropagation(),m(p.id)},className:"p-1 opacity-0 group-hover:opacity-100 hover:text-red-400",children:e.jsx(ee,{className:"w-3 h-3"})})]},p.id)),t.length===0&&!a&&e.jsxs("div",{className:"text-center py-8 text-dark-500",children:[e.jsx(Ce,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No test suites yet"}),e.jsx("button",{onClick:()=>c(!0),className:"btn btn-sm btn-primary mt-4",children:"Create your first suite"})]})]})]})}function Ft({suiteId:n,selectedTestId:s,onSelectTest:t}){const[i,a]=v.useState([]),[c,r]=v.useState(!1),[d,o]=v.useState(""),[m,p]=v.useState("");v.useEffect(()=>{n?Y.getBySuite(n).then(a):Y.getAll().then(a)},[n]);const x=async()=>{if(!(!d.trim()||!n))try{await Y.createNew(n,d.trim(),m||"https://");const l=await Y.getBySuite(n);a(l),o(""),p(""),r(!1),y.success("Test created")}catch{y.error("Failed to create test")}},f=async l=>{if(confirm("Delete this test?"))try{if(await Y.delete(l),n){const h=await Y.getBySuite(n);a(h)}s===l&&t(null),y.success("Test deleted")}catch{y.error("Failed to delete test")}};return n?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-sm font-medium text-dark-400 uppercase tracking-wider",children:["Tests (",i.length,")"]}),e.jsxs("button",{onClick:()=>r(!0),className:"btn btn-sm btn-ghost",children:[e.jsx(ue,{className:"w-4 h-4"}),"New Test"]})]}),c&&e.jsxs("div",{className:"card p-3 space-y-2",children:[e.jsx("input",{type:"text",placeholder:"Test name",value:d,onChange:l=>o(l.target.value),className:"input",autoFocus:!0}),e.jsx("input",{type:"url",placeholder:"Starting URL (https://...)",value:m,onChange:l=>p(l.target.value),className:"input"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:x,className:"btn btn-sm btn-primary",children:"Create"}),e.jsx("button",{onClick:()=>r(!1),className:"btn btn-sm btn-ghost",children:"Cancel"})]})]}),e.jsxs("div",{className:"space-y-2",children:[i.map(l=>e.jsx("div",{className:z("card p-3 cursor-pointer transition-colors",s===l.id?"ring-2 ring-accent":"hover:bg-dark-750"),onClick:()=>t(l.id),children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium text-dark-100 truncate",children:l.name}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-dark-500 mt-1",children:[e.jsx(et,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:l.url})]}),e.jsxs("div",{className:"text-xs text-dark-500 mt-1",children:[l.steps.length," steps"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:h=>{h.stopPropagation(),y.success("Running test...")},className:"btn btn-icon btn-sm btn-ghost text-accent hover:bg-accent/20",children:e.jsx(ye,{className:"w-4 h-4"})}),e.jsx("button",{onClick:h=>{h.stopPropagation(),f(l.id)},className:"btn btn-icon btn-sm btn-ghost text-dark-400 hover:text-red-400",children:e.jsx(ee,{className:"w-4 h-4"})})]})]})},l.id)),i.length===0&&!c&&e.jsxs("div",{className:"text-center py-8 text-dark-500",children:[e.jsx(Ae,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No tests in this suite"}),e.jsx("button",{onClick:()=>r(!0),className:"btn btn-sm btn-primary mt-4",children:"Create your first test"})]})]})]}):e.jsxs("div",{className:"text-center py-12 text-dark-500",children:[e.jsx(Ae,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Select a suite to view tests"})]})}function Et(n,s){let t=null;const i=function(...a){const c=()=>{t=null,n.apply(this,a)};t&&clearTimeout(t),t=setTimeout(c,s)};return i.cancel=()=>{t&&(clearTimeout(t),t=null)},i}function Dt(n){const[s,t]=v.useState({isValid:!1,count:0,status:"validating",message:""});return v.useEffect(()=>{if(!n||n.trim()===""){t({isValid:!1,count:0,status:"invalid",message:"Enter a selector"});return}const i=Et(async()=>{var a;try{const[c]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(c!=null&&c.id)){t({isValid:!1,count:0,status:"error",message:"No active tab"});return}let r;try{r=await chrome.tabs.sendMessage(c.id,{type:"selector:validate",selector:n})}catch{try{await chrome.scripting.executeScript({target:{tabId:c.id},files:["content.js"]}),await new Promise(o=>setTimeout(o,300)),r=await chrome.tabs.sendMessage(c.id,{type:"selector:validate",selector:n})}catch{t({isValid:!1,count:0,status:"error",message:"Content script not available"});return}}if(!r){t({isValid:!1,count:0,status:"error",message:"Cannot validate"});return}r.count===0?t({isValid:!1,count:0,status:"invalid",message:"No elements found"}):r.count===1?t({isValid:!0,count:1,status:"valid",message:`Found: ${((a=r.element)==null?void 0:a.tag)||"element"}`}):t({isValid:!0,count:r.count,status:"multiple",message:`${r.count} elements found`})}catch{t({isValid:!1,count:0,status:"error",message:"Validation error"})}},500);return i(),()=>{var a;(a=i.cancel)==null||a.call(i)}},[n]),s}function Fe({value:n,onChange:s,suggestions:t=[],onSuggestionsRequest:i}){const a=Dt(n),[c,r]=v.useState(!1),[d,o]=v.useState(!1),m=async()=>{if(n)try{const[l]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(l!=null&&l.id))return;await chrome.tabs.sendMessage(l.id,{type:"ping"}).catch(async()=>{await chrome.scripting.executeScript({target:{tabId:l.id},files:["content.js"]}),await new Promise(h=>setTimeout(h,200))}),await chrome.tabs.sendMessage(l.id,{type:"element:highlight",selector:n})}catch(l){console.error("Failed to highlight element:",l)}},p=async()=>{try{o(!0);const[l]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(l!=null&&l.id))throw new Error("No active tab");await chrome.tabs.sendMessage(l.id,{type:"ping"}).catch(async()=>{await chrome.scripting.executeScript({target:{tabId:l.id},files:["content.js"]}),await new Promise(u=>setTimeout(u,200))}),await chrome.tabs.sendMessage(l.id,{type:"picker:start"});const h=u=>{u.type==="picker:element-selected"&&(u.selectors&&u.selectors.length>0&&(s(u.selectors[0].value,u.selectors),i&&i()),chrome.runtime.onMessage.removeListener(h),o(!1))};chrome.runtime.onMessage.addListener(h),setTimeout(()=>{chrome.runtime.onMessage.removeListener(h),o(!1)},6e4)}catch(l){console.error("Failed to pick element:",l),o(!1)}},x=()=>{switch(a.status){case"validating":return e.jsx(ne,{className:"w-4 h-4 animate-spin text-dark-500"});case"valid":return e.jsx(pe,{className:"w-4 h-4 text-green-400"});case"multiple":return e.jsx(me,{className:"w-4 h-4 text-yellow-400"});case"invalid":case"error":return e.jsx(me,{className:"w-4 h-4 text-red-400"})}},f=()=>{switch(a.status){case"valid":return"border-green-400 focus:ring-green-400";case"multiple":return"border-yellow-400 focus:ring-yellow-400";case"invalid":case"error":return"border-red-400 focus:ring-red-400";default:return"border-dark-700"}};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",value:n,onChange:l=>s(l.target.value),placeholder:"#id, .class, [attr], button[type='submit']",className:z("input pr-10 font-mono text-sm transition-all",f())}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1",children:x()})]}),a.isValid&&e.jsx("button",{onClick:m,className:"btn btn-sm btn-ghost",title:"Preview element on page",children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsxs("button",{onClick:p,disabled:d,className:z("btn btn-sm",d?"btn-ghost animate-pulse":"btn-primary"),title:"Pick element from page",children:[e.jsx(Re,{className:"w-4 h-4"}),d?"Picking...":"Pick"]}),t.length>0&&e.jsx("button",{onClick:()=>r(!c),className:"btn btn-sm btn-ghost",title:"Show selector suggestions",children:c?e.jsx(tt,{className:"w-4 h-4"}):e.jsx(de,{className:"w-4 h-4"})})]}),a.message&&e.jsx("p",{className:z("text-xs mt-1",a.status==="valid"?"text-green-400":a.status==="multiple"?"text-yellow-400":"text-red-400"),children:a.message})]}),c&&t.length>0&&e.jsxs("div",{className:"bg-dark-850 border border-dark-700 rounded-lg p-2 space-y-1",children:[e.jsx("div",{className:"text-xs text-dark-400 px-2 py-1",children:"Suggestions (click to use):"}),t.slice(0,5).map((l,h)=>e.jsx("button",{onClick:()=>{s(l.value),r(!1)},className:"w-full text-left px-3 py-2 rounded hover:bg-dark-700 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("code",{className:"text-xs text-dark-200 font-mono",children:l.value}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-dark-500",children:l.type}),e.jsxs("span",{className:z("text-xs px-1.5 py-0.5 rounded",l.confidence>.8?"bg-green-400/20 text-green-400":l.confidence>.6?"bg-yellow-400/20 text-yellow-400":"bg-dark-700 text-dark-400"),children:[Math.round(l.confidence*100),"%"]})]})]})},h))]})]})}function Rt(){const[n,s]=v.useState(!0);return n?e.jsx("div",{className:"bg-accent/10 border border-accent/30 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx(st,{className:"w-5 h-5 text-accent flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium text-accent",children:"Selector Tips"}),e.jsxs("div",{className:"text-xs text-dark-300 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"text-dark-200",children:"1. Use the Pick button"})," - Click on the page element directly"]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-dark-200",children:"2. By ID:"})," ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"#email"})," - Most reliable"]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-dark-200",children:"3. By name:"})," ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:'input[name="email"]'})]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-dark-200",children:"4. By type:"})," ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:'button[type="submit"]'})]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-dark-200",children:"5. By placeholder:"})," ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:'input[placeholder="Email"]'})]})]})]}),e.jsx("button",{onClick:()=>s(!1),className:"btn btn-icon btn-sm btn-ghost flex-shrink-0",children:e.jsx(we,{className:"w-4 h-4"})})]})}):null}const Pt=[{type:"navigate",label:"Navigate",icon:Pe,description:"Go to a URL"},{type:"click",label:"Click",icon:je,description:"Click an element"},{type:"type",label:"Type",icon:Le,description:"Enter text into a field"},{type:"select",label:"Select",icon:Me,description:"Select from dropdown"},{type:"assert",label:"Assert",icon:Se,description:"Verify element text/visibility"},{type:"wait",label:"Wait",icon:Ne,description:"Wait for element or time"}];function Lt({steps:n,onStepsChange:s,currentStepId:t,stepResults:i}){const[a,c]=v.useState(null),[r,d]=v.useState(!1),o=l=>i==null?void 0:i.find(h=>h.stepId===l),m=l=>{const h=zt(l,n.length);s([...n,h]),c(h.id),d(!1)},p=(l,h)=>{s(n.map(u=>u.id===l?{...u,...h}:u))},x=l=>{s(n.filter(h=>h.id!==l)),a===l&&c(null)},f=(l,h)=>{const u=h==="up"?l-1:l+1;if(u<0||u>=n.length)return;const w=[...n];[w[l],w[u]]=[w[u],w[l]],w.forEach((T,W)=>T.order=W),s(w)};return e.jsxs("div",{className:"space-y-3",children:[e.jsx(Rt,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-medium text-dark-300",children:["Steps (",n.length,")"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>d(!r),className:"btn btn-sm btn-primary",children:[e.jsx(ue,{className:"w-4 h-4"}),"Add Step"]}),r&&e.jsx("div",{className:"absolute right-0 top-full mt-1 w-56 bg-dark-800 border border-dark-700 rounded-lg shadow-xl z-10",children:Pt.map(({type:l,label:h,icon:u,description:w})=>e.jsxs("button",{onClick:()=>m(l),className:"w-full flex items-center gap-3 px-3 py-2 hover:bg-dark-700 text-left first:rounded-t-lg last:rounded-b-lg",children:[e.jsx(u,{className:"w-4 h-4 text-accent"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-dark-100",children:h}),e.jsx("div",{className:"text-xs text-dark-500",children:w})]})]},l))})]})]}),n.length===0?e.jsxs("div",{className:"text-center py-8 text-dark-500 border border-dashed border-dark-700 rounded-lg",children:[e.jsx(je,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No steps yet"}),e.jsx("p",{className:"text-xs mt-1",children:'Click "Add Step" to create your first test step'})]}):e.jsx("div",{className:"space-y-2",children:n.map((l,h)=>e.jsx(Mt,{step:l,index:h,isExpanded:a===l.id,isCurrent:t===l.id,result:o(l.id),onToggle:()=>c(a===l.id?null:l.id),onUpdate:u=>p(l.id,u),onDelete:()=>x(l.id),onMove:u=>f(h,u),canMoveUp:h>0,canMoveDown:h<n.length-1},l.id))})]})}function Mt({step:n,index:s,isExpanded:t,isCurrent:i,result:a,onToggle:c,onUpdate:r,onDelete:d,onMove:o,canMoveUp:m,canMoveDown:p}){var W,U;const f=(()=>{switch(n.action.type){case"navigate":return Pe;case"click":case"dblclick":return je;case"type":return Le;case"select":return Me;case"waitForElement":return Ne;default:return Se}})(),l=P=>{r({action:{...n.action,...P}})},h=(P,Q)=>{if(Q)r({selectors:Q});else{const J=n.selectors.length>1?n.selectors:[],j=[{type:"css",value:P,priority:0,confidence:1},...J.slice(1)];r({selectors:j})}},u=()=>i?"border-blue-400 shadow-lg shadow-blue-400/20":(a==null?void 0:a.status)==="passed"?"border-green-400":(a==null?void 0:a.status)==="failed"?"border-red-400":t?"border-accent":"border-dark-700",w=()=>i?"bg-blue-400/5":(a==null?void 0:a.status)==="passed"?"bg-green-400/5":(a==null?void 0:a.status)==="failed"?"bg-red-400/5":t?"bg-dark-850":"bg-dark-800",T=()=>i?e.jsx(ne,{className:"w-4 h-4 text-blue-400 animate-spin"}):(a==null?void 0:a.status)==="passed"?e.jsx(pe,{className:"w-4 h-4 text-green-400"}):(a==null?void 0:a.status)==="failed"?e.jsx(he,{className:"w-4 h-4 text-red-400"}):null;return e.jsxs("div",{className:z("border rounded-lg transition-all duration-200",u(),w()),children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 cursor-pointer",onClick:c,children:[e.jsx(at,{className:"w-4 h-4 text-dark-600 cursor-grab"}),e.jsx("span",{className:z("w-6 h-6 flex items-center justify-center rounded text-xs",i?"bg-blue-400/20 text-blue-400":(a==null?void 0:a.status)==="passed"?"bg-green-400/20 text-green-400":(a==null?void 0:a.status)==="failed"?"bg-red-400/20 text-red-400":"bg-dark-700 text-dark-400"),children:s+1}),e.jsx(f,{className:z("w-4 h-4",i?"text-blue-400":(a==null?void 0:a.status)==="passed"?"text-green-400":(a==null?void 0:a.status)==="failed"?"text-red-400":"text-accent")}),e.jsx("span",{className:z("flex-1 text-sm truncate",i?"text-blue-300 font-medium":(a==null?void 0:a.status)==="passed"?"text-green-300":(a==null?void 0:a.status)==="failed"?"text-red-300":"text-dark-200"),children:n.name}),T(),(a==null?void 0:a.duration)&&e.jsxs("span",{className:"text-xs text-dark-500",children:[a.duration,"ms"]}),t?e.jsx(de,{className:"w-4 h-4 text-dark-500"}):e.jsx(ve,{className:"w-4 h-4 text-dark-500"})]}),(a==null?void 0:a.error)&&!t&&e.jsx("div",{className:"px-3 pb-2",children:e.jsx("div",{className:"text-xs text-red-400 bg-red-400/10 rounded px-2 py-1",children:a.error})}),t&&e.jsxs("div",{className:"px-3 pb-3 space-y-3 border-t border-dark-700 pt-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-dark-400 mb-1",children:"Step Name"}),e.jsx("input",{type:"text",value:n.name,onChange:P=>r({name:P.target.value}),className:"input"})]}),n.action.type==="navigate"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs text-dark-400 mb-1",children:["URL ",e.jsxs("span",{className:"text-dark-600",children:["(use ","{{variable}}"," for data)"]})]}),e.jsx("input",{type:"text",value:n.action.url||"",onChange:P=>l({url:P.target.value}),placeholder:"https://example.com/{{page}}",className:"input"})]}),["click","type","select","waitForElement"].includes(n.action.type)&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs text-dark-400 mb-1",children:["Element Selector ",e.jsx("span",{className:"text-dark-600",children:"(CSS selector, or use Pick button)"})]}),e.jsx(Fe,{value:((W=n.selectors[0])==null?void 0:W.value)||"",onChange:h,suggestions:n.selectors,onSuggestionsRequest:()=>{}})]}),n.action.type==="type"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs text-dark-400 mb-1",children:["Text to Type ",e.jsxs("span",{className:"text-dark-600",children:["(use ","{{variable}}"," for data)"]})]}),e.jsx("input",{type:"text",value:n.action.text||"",onChange:P=>l({text:P.target.value}),placeholder:"{{email}}",className:"input"})]}),n.action.type==="select"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs text-dark-400 mb-1",children:["Value to Select ",e.jsxs("span",{className:"text-dark-600",children:["(use ","{{variable}}"," for data)"]})]}),e.jsx("input",{type:"text",value:n.action.value||"",onChange:P=>l({value:P.target.value}),placeholder:"{{option}}",className:"input"})]}),(n.action.type==="waitTime"||n.action.type==="waitForElement")&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-dark-400 mb-2",children:"Wait Type"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>l({type:"waitTime",duration:2e3}),className:z("flex-1 px-3 py-2 rounded-lg text-sm transition-colors",n.action.type==="waitTime"?"bg-accent text-white":"bg-dark-700 text-dark-300 hover:bg-dark-600"),children:"Wait for Time"}),e.jsx("button",{onClick:()=>{l({type:"waitForElement"}),n.selectors.length===0&&r({selectors:[{type:"css",value:"",priority:0,confidence:1}]})},className:z("flex-1 px-3 py-2 rounded-lg text-sm transition-colors",n.action.type==="waitForElement"?"bg-accent text-white":"bg-dark-700 text-dark-300 hover:bg-dark-600"),children:"Wait for Element"})]})]}),n.action.type==="waitTime"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-dark-400 mb-1",children:"Duration (milliseconds)"}),e.jsx("input",{type:"number",value:n.action.duration||2e3,onChange:P=>l({duration:parseInt(P.target.value)||2e3}),placeholder:"2000",min:"100",step:"100",className:"input"}),e.jsxs("p",{className:"text-xs text-dark-500 mt-1",children:[(n.action.duration||2e3)/1e3," seconds"]})]}),n.action.type==="waitForElement"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs text-dark-400 mb-1",children:["Element Selector ",e.jsx("span",{className:"text-dark-600",children:"(CSS selector, or use Pick button)"})]}),e.jsx(Fe,{value:((U=n.selectors[0])==null?void 0:U.value)||"",onChange:h,suggestions:n.selectors,onSuggestionsRequest:()=>{}})]})]}),(a==null?void 0:a.error)&&e.jsx("div",{className:"bg-red-400/10 border border-red-400/20 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(he,{className:"w-4 h-4 text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-red-300 mb-1",children:"Step Failed"}),e.jsx("div",{className:"text-xs text-red-200",children:a.error}),a.duration&&e.jsxs("div",{className:"text-xs text-red-400/60 mt-1",children:["Failed after ",a.duration,"ms"]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>o("up"),disabled:!m,className:"btn btn-icon btn-sm btn-ghost disabled:opacity-30",title:"Move up",children:e.jsx(de,{className:"w-4 h-4 rotate-180"})}),e.jsx("button",{onClick:()=>o("down"),disabled:!p,className:"btn btn-icon btn-sm btn-ghost disabled:opacity-30",title:"Move down",children:e.jsx(de,{className:"w-4 h-4"})})]}),e.jsxs("button",{onClick:d,className:"btn btn-sm btn-ghost text-red-400 hover:bg-red-400/10",children:[e.jsx(ee,{className:"w-4 h-4"}),"Delete"]})]})]})]})}function zt(n,s){const i={id:crypto.randomUUID(),type:"ui",order:s,enabled:!0,continueOnFailure:!1,selectors:[]};switch(n){case"navigate":return{...i,name:"Navigate to URL",action:{type:"navigate",url:""},selectors:[]};case"click":return{...i,name:"Click element",action:{type:"click"},selectors:[{type:"css",value:"",priority:0,confidence:1}]};case"type":return{...i,name:"Type text",action:{type:"type",text:""},selectors:[{type:"css",value:"",priority:0,confidence:1}]};case"select":return{...i,name:"Select option",action:{type:"select",value:""},selectors:[{type:"css",value:"",priority:0,confidence:1}]};case"assert":return{...i,name:"Assert element visible",action:{type:"waitForElement"},selectors:[{type:"css",value:"",priority:0,confidence:1}],assertions:[{type:"visibility",expected:"visible"}]};case"wait":return{...i,name:"Wait",action:{type:"waitTime",duration:2e3},selectors:[]};default:return{...i,name:"New step",action:{type:"click"},selectors:[]}}}function Ot({dataSets:n,onDataSetsChange:s,onGenerateWithAI:t,onGenerateScenarioData:i,dataSetScenarios:a}){const[c,r]=v.useState(0),[d,o]=v.useState(""),m=j=>({"best-case":"Best Case","worst-case":"Worst Case","edge-case":"Edge Case",boundary:"Boundary",normal:"Normal"})[j]||j,p=j=>{switch(j){case"best-case":return e.jsx(Re,{className:"w-3 h-3"});case"worst-case":return e.jsx(ct,{className:"w-3 h-3"});case"edge-case":return e.jsx($e,{className:"w-3 h-3"});case"boundary":return e.jsx(it,{className:"w-3 h-3"});default:return null}},x=j=>{switch(j){case"best-case":return"bg-green-500/20 text-green-400 border-green-500/30";case"worst-case":return"bg-red-500/20 text-red-400 border-red-500/30";case"edge-case":return"bg-yellow-500/20 text-yellow-400 border-yellow-500/30";case"boundary":return"bg-blue-500/20 text-blue-400 border-blue-500/30";default:return"bg-dark-700 text-dark-400 border-dark-600"}},f=a==null?void 0:a[c],l=n.length>0?n:[{}],h=l[c]||{},u=Array.from(new Set(l.flatMap(j=>Object.keys(j)))),w=j=>{const O=[...l];O[c]={...h,...j},s(O)},T=()=>{d.trim()&&(w({[d.trim()]:""}),o(""))},W=j=>{const O=l.map(H=>{const b={...H};return delete b[j],b});s(O)},U=()=>{const j={};u.forEach(O=>j[O]=""),s([...l,j]),r(l.length)},P=()=>{const j={...h};s([...l,j]),r(l.length)},Q=()=>{if(l.length<=1)return;const j=l.filter((O,H)=>H!==c);s(j),r(Math.min(c,j.length-1))},J=j=>{var b;const O=(b=j.target.files)==null?void 0:b[0];if(!O)return;const H=new FileReader;H.onload=M=>{var _;const F=(_=M.target)==null?void 0:_.result;try{const E=JSON.parse(F);Array.isArray(E)?s(E):s([E])}catch{const E=F.trim().split(`
`);if(E.length<2)return;const C=E[0].split(",").map(A=>A.trim()),V=E.slice(1).map(A=>{const q=A.split(",").map($=>$.trim()),g={};return C.forEach(($,S)=>{g[$]=q[S]||""}),g});s(V)}},H.readAsText(O)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-dark-300",children:"Test Data"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"btn btn-sm btn-ghost cursor-pointer",children:[e.jsx(rt,{className:"w-4 h-4"}),"Import",e.jsx("input",{type:"file",accept:".json,.csv",onChange:J,className:"hidden"})]}),t&&e.jsxs("button",{onClick:t,className:"btn btn-sm btn-ghost text-accent",title:"Generate basic test data",children:[e.jsx(ze,{className:"w-4 h-4"}),"AI"]}),i&&e.jsxs("button",{onClick:i,className:"btn btn-sm btn-ghost text-purple-400",title:"Generate scenario-based test data (best case, worst case, edge cases)",children:[e.jsx($e,{className:"w-4 h-4"}),"Scenarios"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-dark-850 rounded-lg px-3 py-2",children:[e.jsx("button",{onClick:()=>r(Math.max(0,c-1)),disabled:c===0,className:"btn btn-icon btn-sm btn-ghost disabled:opacity-30",children:e.jsx(nt,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-dark-300",children:["Data Set ",c+1," of ",l.length]}),f&&e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded border ${x(f)}`,children:[p(f),m(f)]})]}),e.jsx("button",{onClick:()=>r(Math.min(l.length-1,c+1)),disabled:c===l.length-1,className:"btn btn-icon btn-sm btn-ghost disabled:opacity-30",children:e.jsx(ve,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:U,className:"btn btn-sm btn-ghost flex-1",children:[e.jsx(ue,{className:"w-4 h-4"}),"New Set"]}),e.jsxs("button",{onClick:P,className:"btn btn-sm btn-ghost flex-1",children:[e.jsx(Oe,{className:"w-4 h-4"}),"Duplicate"]}),e.jsx("button",{onClick:Q,disabled:l.length<=1,className:"btn btn-sm btn-ghost text-red-400 disabled:opacity-30",children:e.jsx(ee,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"space-y-2",children:u.length===0?e.jsxs("div",{className:"text-center py-6 text-dark-500 border border-dashed border-dark-700 rounded-lg",children:[e.jsx("p",{className:"text-sm",children:"No variables defined"}),e.jsx("p",{className:"text-xs mt-1",children:"Add variables below to use in your test steps"})]}):u.map(j=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1/3",children:e.jsx("div",{className:"px-3 py-2 bg-dark-850 rounded-lg text-sm text-dark-300 font-mono",children:`{{${j}}}`})}),e.jsx("input",{type:"text",value:h[j]||"",onChange:O=>w({[j]:O.target.value}),placeholder:`Enter ${j}...`,className:"input flex-1"}),e.jsx("button",{onClick:()=>W(j),className:"btn btn-icon btn-sm btn-ghost text-dark-500 hover:text-red-400",children:e.jsx(ee,{className:"w-4 h-4"})})]},j))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:d,onChange:j=>o(j.target.value),onKeyDown:j=>j.key==="Enter"&&T(),placeholder:"Variable name (e.g., email, password)",className:"input flex-1"}),e.jsxs("button",{onClick:T,className:"btn btn-sm btn-primary",children:[e.jsx(ue,{className:"w-4 h-4"}),"Add"]})]}),e.jsx("div",{className:"bg-dark-850 rounded-lg px-3 py-2 text-xs text-dark-500",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Tip:"})," Use ",e.jsx("code",{className:"bg-dark-700 px-1 rounded",children:"{{variableName}}"})," in your test steps to substitute these values."]})})]})}class ge{static generatePlaywright(s,t,i={}){const{includeComments:a=!0}=i,c=s.steps.filter(o=>o.type==="ui");let r="";if(r+=`import { test, expect } from '@playwright/test';

`,a&&(r+=`/**
`,r+=` * Test: ${s.name}
`,r+=` * Generated by QAerx
`,r+=` * URL: ${s.url}
`,r+=` */

`),t.length>0&&Object.keys(t[0]).length>0?(r+=`const testData = ${JSON.stringify(t,null,2)};

`,r+=`for (const data of testData) {
`,r+=`  test(\`${s.name} - \${JSON.stringify(data)}\`, async ({ page }) => {
`):r+=`test('${s.name}', async ({ page }) => {
`,s.url&&s.url!=="https://"){const o=t.length>0?"    ":"  ";r+=`${o}// Navigate to test URL
`,r+=`${o}await page.goto('${this.escapeString(s.url)}');

`}const d=t.length>0?"    ":"  ";return c.forEach((o,m)=>{a&&(r+=`${d}// Step ${m+1}: ${o.name}
`),r+=this.generatePlaywrightStep(o,d,t.length>0),r+=`
`}),t.length>0&&Object.keys(t[0]).length>0?(r+=`  });
`,r+=`}
`):r+=`});
`,r}static generateCypress(s,t,i={}){const{includeComments:a=!0}=i,c=s.steps.filter(d=>d.type==="ui");let r="";if(a&&(r+=`/**
`,r+=` * Test: ${s.name}
`,r+=` * Generated by QAerx
`,r+=` * URL: ${s.url}
`,r+=` */

`),t.length>0&&Object.keys(t[0]).length>0&&(r+=`const testData = ${JSON.stringify(t,null,2)};

`),r+=`describe('${s.name}', () => {
`,s.url&&s.url!=="https://"&&(r+=`  beforeEach(() => {
`,r+=`    cy.visit('${this.escapeString(s.url)}');
`,r+=`  });

`),t.length>0&&Object.keys(t[0]).length>0){r+=`  testData.forEach((data, index) => {
`,r+="    it(`should complete test with data set ${index + 1}`, () => {\n";const d="      ";c.forEach((o,m)=>{a&&(r+=`${d}// Step ${m+1}: ${o.name}
`),r+=this.generateCypressStep(o,d,!0),r+=`
`}),r+=`    });
`,r+=`  });
`}else{r+=`  it('should complete successfully', () => {
`;const d="    ";c.forEach((o,m)=>{a&&(r+=`${d}// Step ${m+1}: ${o.name}
`),r+=this.generateCypressStep(o,d,!1),r+=`
`}),r+=`  });
`}return r+=`});
`,r}static generateSelenium(s,t,i={}){const{includeComments:a=!0}=i,c=s.steps.filter(d=>d.type==="ui");let r="";if(r+=`from selenium import webdriver
`,r+=`from selenium.webdriver.common.by import By
`,r+=`from selenium.webdriver.support.ui import WebDriverWait
`,r+=`from selenium.webdriver.support import expected_conditions as EC
`,r+=`from selenium.webdriver.support.select import Select
`,r+=`import unittest
`,r+=`import time

`,a&&(r+=`"""
`,r+=`Test: ${s.name}
`,r+=`Generated by QAerx
`,r+=`URL: ${s.url}
`,r+=`"""

`),t.length>0&&Object.keys(t[0]).length>0&&(r+=`test_data = ${JSON.stringify(t,null,4).replace(/"/g,"'").replace(/null/g,"None")}

`),r+=`class Test${this.toPascalCase(s.name)}(unittest.TestCase):
`,r+=`    def setUp(self):
`,r+=`        self.driver = webdriver.Chrome()
`,r+=`        self.driver.implicitly_wait(10)
`,s.url&&s.url!=="https://"&&(r+=`        self.driver.get("${s.url}")
`),r+=`
`,r+=`    def tearDown(self):
`,r+=`        self.driver.quit()

`,t.length>0&&Object.keys(t[0]).length>0){r+=`    def test_with_data(self):
`,r+=`        for data in test_data:
`;const d="            ";c.forEach((o,m)=>{a&&(r+=`${d}# Step ${m+1}: ${o.name}
`),r+=this.generateSeleniumStep(o,d,!0),r+=`
`})}else{r+=`    def test_main(self):
`;const d="        ";c.forEach((o,m)=>{a&&(r+=`${d}# Step ${m+1}: ${o.name}
`),r+=this.generateSeleniumStep(o,d,!1),r+=`
`})}return r+=`
if __name__ == "__main__":
`,r+=`    unittest.main()
`,r}static generatePlaywrightStep(s,t,i){var d;const a=s.action,c=((d=s.selectors[0])==null?void 0:d.value)||"",r=o=>i?o.replace(/\{\{(\w+)\}\}/g,"${data.$1}"):o;switch(a.type){case"navigate":const o=r(a.url||"");return`${t}await page.goto(\`${o}\`);`;case"click":return`${t}await page.locator('${this.escapeString(c)}').click();`;case"dblclick":return`${t}await page.locator('${this.escapeString(c)}').dblclick();`;case"type":const m=r(a.text||"");return`${t}await page.locator('${this.escapeString(c)}').fill(\`${m}\`);`;case"select":const p=r(a.value||"");return`${t}await page.locator('${this.escapeString(c)}').selectOption(\`${p}\`);`;case"check":return`${t}await page.locator('${this.escapeString(c)}').check();`;case"uncheck":return`${t}await page.locator('${this.escapeString(c)}').uncheck();`;case"waitTime":return`${t}await page.waitForTimeout(${a.duration||2e3});`;case"waitForElement":return`${t}await page.locator('${this.escapeString(c)}').waitFor();`;case"scroll":return`${t}await page.evaluate(() => window.scrollTo(${a.x||0}, ${a.y||0}));`;default:return`${t}// Unknown action: ${a.type}`}}static generateCypressStep(s,t,i){var d;const a=s.action,c=((d=s.selectors[0])==null?void 0:d.value)||"",r=o=>i?o.replace(/\{\{(\w+)\}\}/g,"${data.$1}"):o;switch(a.type){case"navigate":const o=r(a.url||"");return`${t}cy.visit(\`${o}\`);`;case"click":return`${t}cy.get('${this.escapeString(c)}').click();`;case"dblclick":return`${t}cy.get('${this.escapeString(c)}').dblclick();`;case"type":const m=r(a.text||"");return`${t}cy.get('${this.escapeString(c)}').clear().type(\`${m}\`);`;case"select":const p=r(a.value||"");return`${t}cy.get('${this.escapeString(c)}').select(\`${p}\`);`;case"check":return`${t}cy.get('${this.escapeString(c)}').check();`;case"uncheck":return`${t}cy.get('${this.escapeString(c)}').uncheck();`;case"waitTime":return`${t}cy.wait(${a.duration||2e3});`;case"waitForElement":return`${t}cy.get('${this.escapeString(c)}').should('be.visible');`;case"scroll":return`${t}cy.scrollTo(${a.x||0}, ${a.y||0});`;default:return`${t}// Unknown action: ${a.type}`}}static generateSeleniumStep(s,t,i){var m;const a=s.action,c=((m=s.selectors[0])==null?void 0:m.value)||"",r=p=>i?p.replace(/\{\{(\w+)\}\}/g,"' + data['$1'] + '"):p,o=(p=>p.startsWith("#")?`By.ID, "${p.slice(1)}"`:p.startsWith(".")&&!p.includes(" ")?`By.CLASS_NAME, "${p.slice(1)}"`:p.startsWith("//")?`By.XPATH, "${p}"`:`By.CSS_SELECTOR, "${p}"`)(c);switch(a.type){case"navigate":const p=r(a.url||"");return`${t}self.driver.get('${p}')`;case"click":return`${t}self.driver.find_element(${o}).click()`;case"dblclick":return`${t}from selenium.webdriver.common.action_chains import ActionChains
${t}ActionChains(self.driver).double_click(self.driver.find_element(${o})).perform()`;case"type":const x=r(a.text||"");return`${t}element = self.driver.find_element(${o})
${t}element.clear()
${t}element.send_keys('${x}')`;case"select":const f=r(a.value||"");return`${t}Select(self.driver.find_element(${o})).select_by_value('${f}')`;case"check":return`${t}checkbox = self.driver.find_element(${o})
${t}if not checkbox.is_selected():
${t}    checkbox.click()`;case"uncheck":return`${t}checkbox = self.driver.find_element(${o})
${t}if checkbox.is_selected():
${t}    checkbox.click()`;case"waitTime":return`${t}time.sleep(${(a.duration||2e3)/1e3})`;case"waitForElement":return`${t}WebDriverWait(self.driver, 30).until(EC.presence_of_element_located((${o})))`;case"scroll":return`${t}self.driver.execute_script("window.scrollTo(${a.x||0}, ${a.y||0})")`;default:return`${t}# Unknown action: ${a.type}`}}static escapeString(s){return s.replace(/'/g,"\\'").replace(/"/g,'\\"')}static toPascalCase(s){return s.replace(/[^a-zA-Z0-9]/g," ").split(" ").filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join("")}}const ae={playwright:{name:"Playwright",description:"Modern end-to-end testing framework by Microsoft",ext:".spec.ts",icon:"ðŸŽ­"},cypress:{name:"Cypress",description:"JavaScript-based testing framework",ext:".cy.js",icon:"ðŸŒ²"},selenium:{name:"Selenium (Python)",description:"Cross-browser automation with Python",ext:".py",icon:"ðŸ"}};function Ut({isOpen:n,onClose:s,test:t,dataSets:i}){const[a,c]=v.useState("playwright"),[r,d]=v.useState(!0),[o,m]=v.useState(!1);if(!n)return null;const x=(()=>{switch(a){case"playwright":return ge.generatePlaywright(t,i,{includeComments:r});case"cypress":return ge.generateCypress(t,i,{includeComments:r});case"selenium":return ge.generateSelenium(t,i,{includeComments:r});default:return""}})(),f=async()=>{try{await navigator.clipboard.writeText(x),m(!0),y.success("Code copied to clipboard"),setTimeout(()=>m(!1),2e3)}catch{y.error("Failed to copy")}},l=()=>{const h=new Blob([x],{type:"text/plain"}),u=URL.createObjectURL(h),w=document.createElement("a");w.href=u,w.download=`${t.name.replace(/[^a-z0-9]/gi,"_")}${ae[a].ext}`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(u),y.success("File downloaded")};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-dark-800 rounded-xl shadow-2xl w-full max-w-3xl mx-4 border border-dark-700 max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-dark-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"w-5 h-5 text-accent"}),e.jsx("h3",{className:"text-lg font-semibold text-dark-100",children:"Export Test Code"})]}),e.jsx("button",{onClick:s,className:"p-1 hover:bg-dark-700 rounded",children:e.jsx(we,{className:"w-5 h-5 text-dark-400"})})]}),e.jsxs("div",{className:"px-4 py-3 border-b border-dark-700",children:[e.jsx("div",{className:"flex gap-2",children:Object.keys(ae).map(h=>e.jsxs("button",{onClick:()=>c(h),className:z("flex-1 px-4 py-3 rounded-lg border-2 transition-all",a===h?"border-accent bg-accent/10 text-dark-100":"border-dark-700 bg-dark-850 text-dark-400 hover:border-dark-600"),children:[e.jsx("div",{className:"text-2xl mb-1",children:ae[h].icon}),e.jsx("div",{className:"font-medium text-sm",children:ae[h].name}),e.jsx("div",{className:"text-xs text-dark-500 mt-0.5",children:ae[h].description})]},h))}),e.jsx("div",{className:"mt-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-dark-300 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:r,onChange:h=>d(h.target.checked),className:"w-4 h-4 rounded border-dark-600 bg-dark-800 text-accent focus:ring-accent/50"}),"Include comments and documentation"]})})]}),e.jsx("div",{className:"flex-1 overflow-hidden p-4",children:e.jsxs("div",{className:"relative h-full",children:[e.jsxs("div",{className:"absolute top-2 right-2 flex gap-2 z-10",children:[e.jsxs("button",{onClick:f,className:"btn btn-sm btn-ghost text-dark-400 hover:text-dark-100",children:[o?e.jsx(ot,{className:"w-4 h-4 text-green-400"}):e.jsx(Oe,{className:"w-4 h-4"}),o?"Copied!":"Copy"]}),e.jsxs("button",{onClick:l,className:"btn btn-sm btn-ghost text-dark-400 hover:text-dark-100",children:[e.jsx(Ie,{className:"w-4 h-4"}),"Download"]})]}),e.jsx("pre",{className:"h-full overflow-auto bg-dark-900 rounded-lg p-4 pt-12 text-sm text-dark-200 font-mono",children:e.jsx("code",{children:x})})]})}),e.jsxs("div",{className:"px-4 py-3 border-t border-dark-700 flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-dark-500",children:[t.steps.length," steps â€¢ ",i.length," data sets"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:s,className:"btn btn-ghost",children:"Cancel"}),e.jsxs("button",{onClick:l,className:"btn btn-primary",children:[e.jsx(Ie,{className:"w-4 h-4"}),"Download ",ae[a].name]})]})]})]})})}class fe{constructor(){K(this,"client",null);K(this,"rateLimitDelay",0);K(this,"lastRequestTime",0);K(this,"minInterval",1e3);K(this,"cache",new Map);K(this,"cacheMaxAge",5*60*1e3)}async initialize(){try{const s=await ce.get();if(!(s!=null&&s.openaiApiKey))throw new Error("OpenAI API key not configured. Please add it in Settings.");return this.client=new lt({apiKey:s.openaiApiKey,dangerouslyAllowBrowser:!0}),!0}catch(s){throw console.error("Failed to initialize AIService:",s),s}}async generateTestData(s,t=3){var d,o;if(!this.client)throw new Error("AIService not initialized");let i=this.extractVariablesFromSteps(s);if(i.length===0&&(i=this.inferFieldsFromSteps(s),i.length===0))throw new Error(`Could not find variables in test steps.

Tips:
1. Use {{variableName}} in step text (e.g., "Type {{email}}")
2. Or add Type steps with selectors like #email, #password, etc.`);const a=s.map((m,p)=>{var f;const x=((f=m.selectors)==null?void 0:f.map(l=>l.value).join(" or "))||"no selector";return`${p+1}. ${m.name}: ${this.describeAction(m)} [selector: ${x}]`}).join(`
`),c="You are a test data generator for automated testing. Generate realistic, diverse test data based on variable names and test context. Consider field types, validation rules, and real-world user scenarios.",r=`Generate ${t} unique test data sets for these variables:

Variables needed: ${i.join(", ")}

Test context:
${a}

Requirements:
- Return ONLY a JSON array of objects
- Each object must have exactly these keys: ${i.join(", ")}
- Make data realistic and diverse (different email domains, name variations, valid formats)
- For emails: use real-looking domains (gmail.com, company.com, etc.)
- For passwords: include mix of letters, numbers, special chars
- For names: use diverse, realistic names
- For numbers: use appropriate formats (phone, zip, etc.)

Example format:
[{"variable1": "value1", "variable2": "value2"}]`;try{const p=(o=(d=(await this.makeRequest(async()=>await this.client.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:c},{role:"user",content:r}],temperature:.8,response_format:{type:"json_object"}}))).choices[0])==null?void 0:d.message)==null?void 0:o.content;if(!p)throw new Error("Empty response from AI");const x=JSON.parse(p);let f=Array.isArray(x)?x:x.data||x.dataSets||[];if(!Array.isArray(f)||f.length===0)throw new Error("AI returned invalid data format");return f.forEach((l,h)=>{i.forEach(u=>{if(!(u in l))throw new Error(`Missing variable "${u}" in data set ${h+1}`)})}),f.slice(0,t)}catch(m){throw this.handleError(m),m}}async generateScenarioTestData(s,t={}){var f,l;if(!this.client)throw new Error("AIService not initialized");const{bestCase:i=1,worstCase:a=2,edgeCase:c=1,boundary:r=1}=t,d=i+a+c+r;let o=this.extractVariablesFromSteps(s);if(o.length===0&&(o=this.inferFieldsFromSteps(s),o.length===0))throw new Error("Could not find variables in test steps. Use {{variableName}} syntax.");const m=s.map((h,u)=>{var T;const w=((T=h.selectors)==null?void 0:T.map(W=>W.value).join(" or "))||"no selector";return`${u+1}. ${h.name}: ${this.describeAction(h)} [selector: ${w}]`}).join(`
`),p="You are a QA test data expert. Generate comprehensive test data covering different scenarios to ensure thorough testing coverage.",x=`Generate test data sets for these variables: ${o.join(", ")}

Test context:
${m}

Generate the following scenarios:
1. BEST CASE (${i} sets): Valid, correctly formatted data that should pass all validations
   - Real email formats (user@domain.com)
   - Strong passwords meeting requirements
   - Properly formatted names, phones, etc.

2. WORST CASE (${a} sets): Invalid data that should fail validation
   - Invalid email formats (missing @, invalid domains)
   - Weak/invalid passwords
   - Empty required fields
   - Special characters that might break input
   - SQL injection attempts (for security testing)
   - XSS attempts (for security testing)

3. EDGE CASE (${c} sets): Unusual but potentially valid data
   - Very long strings (near max length)
   - Unicode characters, emojis
   - Leading/trailing spaces
   - Multiple consecutive spaces

4. BOUNDARY (${r} sets): Data at validation boundaries
   - Minimum length values
   - Maximum length values
   - Just under/over limits

Return ONLY valid JSON in this exact format:
{
  "dataSets": [
    {"scenario": "best-case", ${o.map(h=>`"${h}": "value"`).join(", ")}},
    {"scenario": "worst-case", ${o.map(h=>`"${h}": "value"`).join(", ")}},
    ...
  ]
}`;try{const u=(l=(f=(await this.makeRequest(async()=>await this.client.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:p},{role:"user",content:x}],temperature:.8,response_format:{type:"json_object"}}))).choices[0])==null?void 0:f.message)==null?void 0:l.content;if(!u)throw new Error("Empty response from AI");const w=JSON.parse(u),T=w.dataSets||w.data||[];if(!Array.isArray(T)||T.length===0)throw new Error("AI returned invalid data format");const W=[],U=[];return T.forEach(P=>{const Q=P.scenario;U.push(Q||"normal");const J={};o.forEach(j=>{J[j]=P[j]||""}),W.push(J)}),{dataSets:W.slice(0,d),scenarios:U.slice(0,d)}}catch(h){throw this.handleError(h),h}}async analyzePageAndSuggestTests(s){var a,c;if(!this.client)throw new Error("AIService not initialized");const t="You are a QA test expert. Analyze web pages and suggest comprehensive test scenarios. Focus on critical user flows, edge cases, and validation tests.",i=`Analyze this page and suggest 5-10 important test steps to cover key functionality:

${s}

Requirements:
- Suggest practical, executable test steps
- Include form validation, navigation, and assertions
- Use actual selectors from the page
- Consider positive and negative test cases
- Return ONLY valid JSON

Format:
{"steps": [{"name": "Step name", "type": "click|type|navigate|waitForElement", "selector": "CSS selector", "text": "text to type (if type action)", "description": "Why this test is important"}]}`;try{const d=(c=(a=(await this.makeRequest(async()=>await this.client.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:t},{role:"user",content:i}],temperature:.7,response_format:{type:"json_object"}}))).choices[0])==null?void 0:a.message)==null?void 0:c.content;if(!d)throw new Error("Empty response from AI");const m=JSON.parse(d).steps||[];if(!Array.isArray(m))throw new Error("AI returned invalid format");return m.map((x,f)=>({id:crypto.randomUUID(),type:"ui",order:f,name:x.name||"AI Suggested Step",description:x.description,enabled:!0,continueOnFailure:!1,action:this.createActionFromSuggestion(x),selectors:x.selector?[{type:"css",value:x.selector,priority:0,confidence:.75}]:[]}))}catch(r){throw this.handleError(r),r}}async suggestSelectors(s,t,i="not-found"){var m,p;if(!this.client)throw new Error("AIService not initialized");const a=`selectors:${this.hashString(t+s.html+i)}`,c=this.getFromCache(a);if(c)return c;const r=i==="not-found"?"0 elements found - selector does not match any element":"Multiple elements found - selector is not unique",d="You are a CSS selector expert. Analyze DOM context and suggest robust, maintainable selectors. Prefer data-testid, ARIA labels, semantic HTML, and stable IDs over brittle class names or complex XPath.",o=`Current selector: ${t}
Issue: ${r}

Page: ${s.metadata.title} (${s.metadata.url})

Simplified DOM:
${this.optimizeDOMSnapshot(s.html)}

Suggest 3-5 alternative selectors ordered by robustness.

Requirements:
- Return ONLY valid JSON
- Prefer: data-testid > ARIA > semantic HTML > stable IDs > classes
- Avoid: auto-generated IDs, CSS framework classes (Tailwind, MUI), nth-child when possible
- Each suggestion needs: type, value, confidence (0-1), explanation

Format:
{"suggestions": [{"type": "css", "value": "[data-testid='btn']", "confidence": 0.95, "explanation": "Uses stable test ID"}]}`;try{const f=(p=(m=(await this.makeRequest(async()=>await this.client.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:d},{role:"user",content:o}],temperature:.3,response_format:{type:"json_object"}}))).choices[0])==null?void 0:m.message)==null?void 0:p.content;if(!f)throw new Error("Empty response from AI");const h=JSON.parse(f).suggestions||[];if(!Array.isArray(h))throw new Error("AI returned invalid suggestions format");const u=h.map((w,T)=>({type:w.type||"css",value:w.value,priority:T,confidence:w.confidence||.5,explanation:w.explanation}));return this.setInCache(a,u),u}catch(x){throw this.handleError(x),x}}async suggestNextStep(s,t){var r,d;if(!this.client)throw new Error("AIService not initialized");const i=s.map((o,m)=>`${m+1}. ${o.name}`).join(`
`),a="You are a QA automation expert. Analyze test context and page state to suggest logical next test steps. Consider common user flows, form validation, and typical test scenarios.",c=`Current test steps:
${i}

Current page:
- URL: ${t.url}
- Title: ${t.title}
- Forms: ${t.forms.length} form(s) ${t.forms.map(o=>`with ${o.fields.length} fields`).join(", ")}
- Buttons: ${t.buttons.map(o=>o.text).join(", ")}
- Links: ${t.links.slice(0,5).map(o=>o.text).join(", ")}
- Filled fields: ${Object.keys(t.currentFormState).join(", ")||"none"}

Suggest the most logical next test step.

Requirements:
- Return ONLY valid JSON
- Consider common flows (login, form fill, navigation, assertions)
- Include: type, name, selector, reasoning
- Type must be one of: click, type, navigate, waitTime, waitForElement

Format:
{"step": {"type": "click", "name": "Click submit button", "selector": "button[type='submit']", "reasoning": "Form filled, next is submission"}}`;try{const m=(d=(r=(await this.makeRequest(async()=>await this.client.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:a},{role:"user",content:c}],temperature:.5,response_format:{type:"json_object"}}))).choices[0])==null?void 0:r.message)==null?void 0:d.content;if(!m)return null;const x=JSON.parse(m).step;return!x||!x.type||!x.selector?null:{id:crypto.randomUUID(),type:"ui",order:s.length,name:x.name||"AI Suggested Step",enabled:!0,continueOnFailure:!1,action:this.createAction(x.type,x),selectors:[{type:"css",value:x.selector,priority:0,confidence:.8}]}}catch(o){return this.handleError(o),null}}async healSelector(s,t,i,a){var d,o;if(!this.client)throw new Error("AIService not initialized");const c="You are a selector repair expert. A test selector failed to find an element. Analyze the DOM to find the element the user likely intended and suggest updated selectors.",r=`Failed selector: ${s}
Error: ${i}
Step context: ${a||"Unknown step"}

Current DOM snapshot:
${this.optimizeDOMSnapshot(t)}

Find the most likely target element and suggest 3-5 alternative selectors.
Consider: renamed classes, moved elements, similar elements nearby, updated IDs.

Requirements:
- Return ONLY valid JSON
- Include confidence (0-1) for overall healing success
- Include explanation of what changed
- Suggest robust selectors

Format:
{"suggestedSelectors": [{"type": "css", "value": ".new-class", "confidence": 0.9}], "confidence": 0.88, "explanation": "Button class changed from .old to .new"}`;try{const p=(o=(d=(await this.makeRequest(async()=>await this.client.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:c},{role:"user",content:r}],temperature:.3,response_format:{type:"json_object"}}))).choices[0])==null?void 0:d.message)==null?void 0:o.content;if(!p)throw new Error("Empty response from AI");const x=JSON.parse(p),f=(x.suggestedSelectors||[]).map((l,h)=>({type:l.type||"css",value:l.value,priority:h,confidence:l.confidence||.5}));return{originalSelector:{type:"css",value:s,priority:0,confidence:0},suggestedSelectors:f,confidence:x.confidence||.5,aiExplanation:x.explanation}}catch(m){throw this.handleError(m),m}}extractVariablesFromSteps(s){const t=new Set;return s.forEach(i=>{const a=i.action;["url","text","value"].forEach(c=>{if(typeof a[c]=="string"){const r=a[c].match(/\{\{(\w+)\}\}/g);r&&r.forEach(d=>{const o=d.replace(/[{}]/g,"");t.add(o)})}})}),Array.from(t)}inferFieldsFromSteps(s){const t=new Set;return s.forEach(i=>{if(i.action.type==="type"&&i.selectors&&i.selectors.length>0){const c=i.selectors[0].value,r=[/id="?(\w+)"?/i,/name="?(\w+)"?/i,/#(\w+)/,/\[name=["']?(\w+)["']?\]/,/\[id=["']?(\w+)["']?\]/,/\[placeholder=["']?([^"']+)["']?\]/i];for(const d of r){const o=c.match(d);if(o&&o[1]){const m=o[1].toLowerCase();if(m.includes("email")||m.includes("user")||m.includes("password")||m.includes("name")||m.includes("phone")||m.includes("address")||m.includes("city")||m.includes("zip")||m.includes("state")){t.add(m);break}}}if(t.size===0){const d=i.name.toLowerCase();d.includes("email")&&t.add("email"),d.includes("password")&&t.add("password"),(d.includes("username")||d.includes("user"))&&t.add("username"),d.includes("name")&&t.add("name")}}}),Array.from(t)}describeAction(s){const t=s.action;switch(t.type){case"type":return`Type "${t.text}" into element`;case"click":return"Click element";case"navigate":return`Navigate to ${t.url}`;case"select":return`Select option "${t.value}"`;case"waitTime":return`Wait ${t.duration}ms`;case"waitForElement":return"Wait for element to appear";default:return t.type}}createAction(s,t){switch(s){case"click":return{type:"click"};case"type":return{type:"type",text:t.text||""};case"navigate":return{type:"navigate",url:t.url||""};case"waitTime":return{type:"waitTime",duration:t.duration||2e3};case"waitForElement":return{type:"waitForElement"};default:return{type:"click"}}}createActionFromSuggestion(s){switch(s.type||"click"){case"type":return{type:"type",text:s.text||""};case"click":return{type:"click"};case"navigate":return{type:"navigate",url:s.url||""};case"waitForElement":return{type:"waitForElement"};case"waitTime":return{type:"waitTime",duration:s.duration||2e3};default:return{type:"click"}}}optimizeDOMSnapshot(s){if(!s)return"";let t=s;return t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""),t=t.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,""),t=t.replace(/<!--[\s\S]*?-->/g,""),t=t.replace(/data:[^"'\s>]+/g,"data:..."),t=t.replace(/>([^<]{100})[^<]*</g,">$1...</"),t=t.replace(/\s+/g," "),t.length>8e3&&(t=t.substring(0,8e3)+`
...[truncated]`),t}async makeRequest(s){var a;const i=Date.now()-this.lastRequestTime;if(i<this.minInterval+this.rateLimitDelay){const c=this.minInterval+this.rateLimitDelay-i;await new Promise(r=>setTimeout(r,c))}this.lastRequestTime=Date.now();try{const c=await s();return this.rateLimitDelay=0,c}catch(c){if((c==null?void 0:c.status)===429){const r=(a=c==null?void 0:c.headers)==null?void 0:a["retry-after"];throw this.rateLimitDelay=r?parseInt(r)*1e3:5e3,new Error(`AI rate limited. Please try again in ${this.rateLimitDelay/1e3}s`)}throw c}}handleError(s){var t;if(console.error("AIService error:",s),(s==null?void 0:s.status)===401)throw new Error("Invalid OpenAI API key. Please update in Settings.");if((s==null?void 0:s.status)===429)throw new Error("AI rate limit exceeded. Please wait before trying again.");if((t=s==null?void 0:s.message)!=null&&t.includes("network")||(s==null?void 0:s.code)==="ECONNREFUSED")throw new Error("Cannot reach OpenAI API. Check your internet connection.")}getFromCache(s){const t=this.cache.get(s);return t?Date.now()-t.timestamp>this.cacheMaxAge?(this.cache.delete(s),null):t.data:null}setInCache(s,t){if(this.cache.set(s,{data:t,timestamp:Date.now()}),this.cache.size>100){const i=this.cache.keys().next().value;i&&this.cache.delete(i)}}hashString(s){let t=0;for(let i=0;i<s.length;i++){const a=s.charCodeAt(i);t=(t<<5)-t+a,t=t&t}return t.toString(36)}}class Bt{static async generateReport(s){const t=new dt,i=t.internal.pageSize.getWidth(),a=t.internal.pageSize.getHeight(),c=s.test.steps.filter(b=>b.type==="ui"),r=c.length,d=s.dataSets.length,o=r*d,m=s.results.filter(b=>b.status==="passed").length,p=s.results.filter(b=>b.status==="failed").length,x=s.completedAt-s.startedAt,f=p===0?"PASSED":"FAILED",l=o>0?(m/o*100).toFixed(1):"0";t.setFillColor(16,185,129),t.rect(0,0,i,45,"F"),t.setTextColor(255,255,255),t.setFontSize(28),t.setFont("helvetica","bold"),t.text("QAerx",20,22),t.setFontSize(14),t.setFont("helvetica","normal"),t.text("Test Execution Report",20,35);const h=f==="PASSED"?[34,197,94]:[239,68,68];t.setFillColor(h[0],h[1],h[2]),t.roundedRect(i-50,15,35,15,3,3,"F"),t.setFontSize(10),t.setTextColor(255,255,255),t.text(f,i-33,25,{align:"center"});let u=60;t.setTextColor(17,24,39),t.setFontSize(16),t.setFont("helvetica","bold"),t.text("Test Information",20,u),u+=5,t.setDrawColor(16,185,129),t.setLineWidth(2),t.line(20,u,60,u),u+=12,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(75,85,99),[{label:"Test Name",value:s.test.name},{label:"Target URL",value:s.test.url||"N/A"},{label:"Executed At",value:new Date(s.startedAt).toLocaleString()},{label:"Duration",value:this.formatDuration(x)},{label:"Data Sets",value:d.toString()},{label:"Total Steps",value:r.toString()}].forEach(({label:b,value:M})=>{t.setFont("helvetica","bold"),t.setTextColor(75,85,99),t.text(b+":",20,u),t.setFont("helvetica","normal"),t.setTextColor(17,24,39),t.text(M,60,u),u+=7}),u+=10,t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(17,24,39),t.text("Execution Summary",20,u),u+=5,t.setDrawColor(16,185,129),t.line(20,u,75,u),u+=15;const T=42,W=35,U=5,P=20;[{label:"Total",value:o.toString(),color:[59,130,246]},{label:"Passed",value:m.toString(),color:[34,197,94]},{label:"Failed",value:p.toString(),color:[239,68,68]},{label:"Success",value:`${l}%`,color:[168,85,247]}].forEach((b,M)=>{const F=P+(T+U)*M;t.setFillColor(249,250,251),t.roundedRect(F,u,T,W,3,3,"F"),t.setFillColor(b.color[0],b.color[1],b.color[2]),t.rect(F,u,T,3,"F"),t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(b.color[0],b.color[1],b.color[2]),t.text(b.value,F+T/2,u+18,{align:"center"}),t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(107,114,128),t.text(b.label,F+T/2,u+28,{align:"center"})}),u+=W+20,t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(17,24,39),t.text("Test Steps Details",20,u),u+=5,t.setDrawColor(16,185,129),t.line(20,u,75,u),u+=10;const J=c.map((b,M)=>{var q;const F=s.results.filter(g=>g.stepId===b.id),_=F.filter(g=>g.status==="passed").length,E=F.length>0?F.reduce((g,$)=>g+($.duration||0),0)/F.length:0,C=b.action,V=((q=b.selectors[0])==null?void 0:q.value)||"-",A=this.sanitizeForPDF(b.name);return[(M+1).toString(),this.truncateString(A,30),this.getActionType(C.type),this.truncateString(V,35),this.getActionValue(b),`${_}/${F.length}`,this.formatDuration(E),_===F.length?"PASS":"FAIL"]});le(t,{startY:u,head:[["#","Step Name","Action","Selector","Value","Pass","Time","Status"]],body:J,theme:"grid",styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[16,185,129],textColor:[255,255,255],fontStyle:"bold",fontSize:8},alternateRowStyles:{fillColor:[249,250,251]},columnStyles:{0:{cellWidth:8,halign:"center"},1:{cellWidth:35},2:{cellWidth:18},3:{cellWidth:40,fontSize:7},4:{cellWidth:30,fontSize:7},5:{cellWidth:15,halign:"center"},6:{cellWidth:18,halign:"center"},7:{cellWidth:15,halign:"center"}},didParseCell:b=>{b.column.index===7&&b.section==="body"&&(b.cell.text[0]==="PASS"?(b.cell.styles.textColor=[34,197,94],b.cell.styles.fontStyle="bold"):b.cell.text[0]==="FAIL"&&(b.cell.styles.textColor=[239,68,68],b.cell.styles.fontStyle="bold"))}}),u=t.lastAutoTable.finalY+20,u>a-80&&(t.addPage(),u=20),t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(17,24,39),t.text("Step-by-Step Execution Log",20,u),u+=5,t.setDrawColor(16,185,129),t.line(20,u,95,u),u+=10;for(let b=0;b<Math.max(1,d);b++){const M=s.results.filter(C=>C.dataSetIndex===b),F=M.every(C=>C.status==="passed");if(u>a-60&&(t.addPage(),u=20),d>1){const C=`Data Set ${b+1}`,V=F?"PASSED":"FAILED",A=F?[34,197,94]:[239,68,68];t.setFillColor(249,250,251),t.roundedRect(20,u-3,i-40,12,2,2,"F"),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(59,130,246),t.text(C,25,u+5),t.setTextColor(A[0],A[1],A[2]),t.text(V,i-45,u+5),u+=15}const _=s.dataSets[b]||{},E=c.map((C,V)=>{const A=M.find(R=>R.stepId===C.id),q=C.action,g=(A==null?void 0:A.status)||"pending",$=A!=null&&A.duration?this.formatDuration(A.duration):"-";let S="";A!=null&&A.pageResponse?S=A.pageResponse:g==="passed"?S=this.getSuccessDescription(C,q,_):g==="failed"?S=(A==null?void 0:A.error)||"Step failed":S="Not executed";const B=this.sanitizeForPDF(C.name);return[`${V+1}`,this.truncateString(B,30),this.getActionDescription(C,q,_),$,g==="passed"?"PASS":g==="failed"?"FAIL":"-",this.truncateString(S,45)]});le(t,{startY:u,head:[["#","Step","Action Performed","Time","Status","Result"]],body:E,theme:"plain",styles:{fontSize:8,cellPadding:2},headStyles:{fillColor:[243,244,246],textColor:[75,85,99],fontStyle:"bold",fontSize:8},columnStyles:{0:{cellWidth:8,halign:"center"},1:{cellWidth:32},2:{cellWidth:48},3:{cellWidth:15,halign:"center"},4:{cellWidth:15,halign:"center"},5:{cellWidth:58}},didParseCell:C=>{if(C.column.index===4&&C.section==="body"&&(C.cell.text[0]==="PASS"?(C.cell.styles.textColor=[34,197,94],C.cell.styles.fontStyle="bold"):C.cell.text[0]==="FAIL"&&(C.cell.styles.textColor=[239,68,68],C.cell.styles.fontStyle="bold")),C.column.index===5&&C.section==="body"){const V=C.row.index,A=M.find(q=>{var g;return q.stepId===((g=c[V])==null?void 0:g.id)});(A==null?void 0:A.status)==="passed"?C.cell.styles.textColor=[34,197,94]:(A==null?void 0:A.status)==="failed"&&(C.cell.styles.textColor=[185,28,28])}}}),u=t.lastAutoTable.finalY+10}if(d>0&&Object.keys(s.dataSets[0]||{}).length>0){u=t.lastAutoTable.finalY+20,u>a-80&&(t.addPage(),u=20),t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(17,24,39),t.text("Test Data Sets",20,u),u+=5,t.setDrawColor(16,185,129),t.line(20,u,65,u),u+=10;const b=Object.keys(s.dataSets[0]).filter(E=>E!=="scenario"),M=s.dataSetScenarios&&s.dataSetScenarios.length>0,F=M?["Set #","Scenario",...b,"Result"]:["Set #",...b,"Result"],_=s.dataSets.map((E,C)=>{var $;const A=s.results.filter(S=>S.dataSetIndex===C).every(S=>S.status==="passed")?"PASS":"FAIL",q=($=s.dataSetScenarios)==null?void 0:$[C],g=q?this.getScenarioLabel(q):"";return M?[(C+1).toString(),g,...b.map(S=>this.truncateString(E[S]||"",20)),A]:[(C+1).toString(),...b.map(S=>this.truncateString(E[S]||"",25)),A]});le(t,{startY:u,head:[F],body:_,theme:"grid",styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[59,130,246],textColor:[255,255,255],fontStyle:"bold"},alternateRowStyles:{fillColor:[249,250,251]},didParseCell:E=>{const C=F.length-1;E.column.index===C&&E.section==="body"&&(E.cell.text[0]==="PASS"?(E.cell.styles.textColor=[34,197,94],E.cell.styles.fontStyle="bold"):E.cell.text[0]==="FAIL"&&(E.cell.styles.textColor=[239,68,68],E.cell.styles.fontStyle="bold"))}})}const j=s.results.filter(b=>b.status==="failed");if(j.length>0){u=t.lastAutoTable.finalY+20,u>a-80&&(t.addPage(),u=20),t.setFillColor(254,242,242),t.roundedRect(15,u-5,i-30,25,3,3,"F"),t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(185,28,28),t.text("Failed Steps Analysis",20,u+8),u+=25;const b=j.map(M=>{var C;const F=c.find(V=>V.id===M.stepId),_=M.dataSetIndex+1,E=((C=F==null?void 0:F.selectors[0])==null?void 0:C.value)||"-";return[(F==null?void 0:F.name)||"Unknown",`Data Set ${_}`,this.truncateString(E,30),this.truncateString(M.error||"Unknown error",50)]});le(t,{startY:u,head:[["Step Name","Data Set","Selector","Error Message"]],body:b,theme:"grid",styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[185,28,28],textColor:[255,255,255],fontStyle:"bold"},alternateRowStyles:{fillColor:[254,242,242]},columnStyles:{0:{cellWidth:45},1:{cellWidth:25},2:{cellWidth:40,fontSize:7},3:{cellWidth:65,fontSize:7}}})}const O=t.internal.pages.length-1;for(let b=1;b<=O;b++)t.setPage(b),t.setDrawColor(229,231,235),t.setLineWidth(.5),t.line(20,a-15,i-20,a-15),t.setFontSize(8),t.setTextColor(156,163,175),t.text("Generated by QAerx - AI-Powered Test Automation",20,a-8),t.text(`Page ${b} of ${O}`,i-20,a-8,{align:"right"});const H=`QAerx_${s.test.name.replace(/[^a-z0-9]/gi,"_")}_${new Date().toISOString().split("T")[0]}.pdf`;t.save(H)}static getScenarioLabel(s){return{"best-case":"Best Case","worst-case":"Worst Case","edge-case":"Edge Case",boundary:"Boundary",normal:"Normal"}[s]||s}static getActionType(s){return{click:"Click",dblclick:"Double Click",type:"Type",navigate:"Navigate",select:"Select",check:"Check",uncheck:"Uncheck",waitTime:"Wait",waitForElement:"Wait Element",scroll:"Scroll"}[s]||s}static getActionValue(s){const t=s.action;switch(t.type){case"type":return this.truncateString(t.text||"",25);case"navigate":return this.truncateString(t.url||"",25);case"select":return this.truncateString(t.value||"",25);case"waitTime":return`${t.duration||2e3}ms`;default:return"-"}}static truncateString(s,t){if(!s)return"-";const i=this.sanitizeForPDF(s);return i.length<=t?i:i.substring(0,t-3)+"..."}static sanitizeForPDF(s){return s?/[^\x00-\x7F]/.test(s)?s.replace(/[\u0600-\u06FF]+/g,"[Arabic]").replace(/[\u4E00-\u9FFF]+/g,"[Chinese]").replace(/[\u3040-\u309F\u30A0-\u30FF]+/g,"[Japanese]").replace(/[\uAC00-\uD7AF]+/g,"[Korean]").replace(/[^\x00-\x7F]+/g,"[...]"):s:""}static formatDuration(s){if(s<1e3)return`${Math.round(s)}ms`;const t=s/1e3;if(t<60)return`${t.toFixed(1)}s`;const i=Math.floor(t/60),a=t%60;return`${i}m ${a.toFixed(0)}s`}static getActionDescription(s,t,i){var d;const a=((d=s.selectors[0])==null?void 0:d.value)||"",c=this.truncateString(a,20),r=o=>i?o.replace(/\{\{(\w+)\}\}/g,(m,p)=>i[p]||p):o;switch(t.type){case"click":return`Clicked on "${c}"`;case"dblclick":return`Double-clicked "${c}"`;case"type":const o=r(t.text||"");return`Typed "${this.truncateString(o,20)}" into field`;case"navigate":return`Navigated to ${this.truncateString(t.url||"",25)}`;case"select":const m=r(t.value||"");return`Selected "${this.truncateString(m,15)}"`;case"check":return"Checked checkbox";case"uncheck":return"Unchecked checkbox";case"waitTime":return`Waited ${t.duration||2e3}ms`;case"waitForElement":return"Waited for element";case"scroll":return`Scrolled to (${t.x||0}, ${t.y||0})`;default:return`Performed ${t.type}`}}static getSuccessDescription(s,t,i){const a=s.name.toLowerCase(),c=r=>i?r.replace(/\{\{(\w+)\}\}/g,(d,o)=>i[o]||o):r;switch(t.type){case"click":return a.includes("login")||a.includes("sign in")?"Login button clicked successfully":a.includes("submit")?"Form submitted successfully":a.includes("save")?"Save action completed":a.includes("delete")||a.includes("remove")?"Delete action completed":a.includes("create")||a.includes("add")?"Create action completed":a.includes("next")||a.includes("continue")?"Navigation to next step completed":"Element clicked successfully";case"type":const r=c(t.text||"");return a.includes("username")||a.includes("email")?`Username/email entered: ${this.truncateString(r,20)}`:a.includes("password")?"Password entered securely":a.includes("search")?`Search query entered: "${this.truncateString(r,20)}"`:`Text entered: "${this.truncateString(r,25)}"`;case"navigate":return"Page loaded successfully";case"select":const d=c(t.value||"");return`Option selected: "${this.truncateString(d,25)}"`;case"check":return"Checkbox checked";case"uncheck":return"Checkbox unchecked";case"waitTime":return`Wait completed (${t.duration||2e3}ms)`;case"waitForElement":return"Element appeared on page";case"scroll":return"Page scrolled to position";default:return"Step completed successfully"}}}function Wt({testId:n,onBack:s}){const[t,i]=v.useState(null),[a,c]=v.useState([]),[r,d]=v.useState([{}]),[o,m]=v.useState([]),[p,x]=v.useState(!1),[f,l]=v.useState("steps"),[h,u]=v.useState(!1),[w,T]=v.useState(null),[W,U]=v.useState(!1),[P,Q]=v.useState(!1),[J,j]=v.useState(!1);v.useEffect(()=>{Y.getById(n).then(g=>{var $,S;g&&(i(g),c(g.steps),d((($=g.dataSource)==null?void 0:$.data)||[{}]),x(((S=g.dataSource)==null?void 0:S.type)==="ai-generated"))})},[n]);const O=g=>{c(g),U(!0)},H=g=>{d(g),m([]),x(!1),U(!0)},b=async()=>{try{if(a.length===0){y.error("Add test steps first before generating data");return}const g=y.loading("Generating test data with AI..."),$=new fe;await $.initialize();const S=r.length>0?r.length:3,B=await $.generateTestData(a,S);d(B),x(!0),U(!0),y.dismiss(g),y.success(`Generated ${B.length} data sets with AI âœ¨`)}catch(g){console.error("AI generation error:",g),y.error(g.message||"Failed to generate data with AI")}},M=async()=>{try{if(a.length===0){y.error("Add test steps first before generating data");return}const g=y.loading("Generating scenario-based test data with AI..."),$=new fe;await $.initialize();const S=await $.generateScenarioTestData(a,{bestCase:1,worstCase:2,edgeCase:1,boundary:1});d(S.dataSets),m(S.scenarios),x(!0),U(!0),y.dismiss(g),y.success(`Generated ${S.dataSets.length} scenario data sets (Best/Worst/Edge/Boundary) âœ¨`)}catch(g){console.error("AI scenario generation error:",g),y.error(g.message||"Failed to generate scenario data with AI")}},F=async()=>{try{j(!0);const g=y.loading("Analyzing page with AI..."),[$]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!$.id)throw new Error("No active tab found");try{await chrome.tabs.sendMessage($.id,{type:"ping"})}catch{await chrome.scripting.executeScript({target:{tabId:$.id},files:["content.js"]}),await new Promise(G=>setTimeout(G,500))}const S=await chrome.tabs.sendMessage($.id,{type:"analyzer:getPageContext"}),B=new fe;await B.initialize();const R=await B.analyzePageAndSuggestTests(S.context);c(G=>[...G,...R]),U(!0),y.dismiss(g),y.success(`AI suggested ${R.length} test steps âœ¨`)}catch(g){console.error("AI analysis error:",g),y.error(g.message||"Failed to analyze page with AI")}finally{j(!1)}},_=async()=>{try{const g=y.loading("Scanning page for form fields..."),[$]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!$.id)throw new Error("No active tab found");try{await chrome.tabs.sendMessage($.id,{type:"ping"})}catch{await chrome.scripting.executeScript({target:{tabId:$.id},files:["content.js"]}),await new Promise(k=>setTimeout(k,500))}const S=await chrome.tabs.sendMessage($.id,{type:"analyzer:getFullAnalysis"});if(!S.success)throw new Error(S.error||"Failed to analyze page");const B=S.analysis,R=[];let G=a.length;B.forms.forEach(k=>{k.fields.forEach(N=>{const L=N.label||N.placeholder||N.name||N.id||"field",D=(N.name||N.id||L).replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();N.type==="text"||N.type==="email"||N.type==="password"||N.type==="tel"||N.type==="number"||N.type==="textarea"?R.push({id:crypto.randomUUID(),type:"ui",order:G++,name:`Enter ${L}`,enabled:!0,continueOnFailure:!1,action:{type:"type",text:`{{${D}}}`},selectors:[{type:"css",value:N.selector,priority:0,confidence:.9}]}):N.type==="select"||N.type==="select-one"?R.push({id:crypto.randomUUID(),type:"ui",order:G++,name:`Select ${L}`,enabled:!0,continueOnFailure:!1,action:{type:"select",value:`{{${D}}}`},selectors:[{type:"css",value:N.selector,priority:0,confidence:.9}]}):(N.type==="checkbox"||N.type==="radio")&&R.push({id:crypto.randomUUID(),type:"ui",order:G++,name:`Check ${L}`,enabled:!0,continueOnFailure:!1,action:{type:"check"},selectors:[{type:"css",value:N.selector,priority:0,confidence:.9}]})})}),B.inputs.forEach(k=>{const N=k.label||k.placeholder||k.name||k.id||"field",L=(k.name||k.id||N).replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();(k.type==="text"||k.type==="email"||k.type==="password"||k.type==="tel"||k.type==="number"||k.type==="textarea")&&R.push({id:crypto.randomUUID(),type:"ui",order:G++,name:`Enter ${N}`,enabled:!0,continueOnFailure:!1,action:{type:"type",text:`{{${L}}}`},selectors:[{type:"css",value:k.selector,priority:0,confidence:.9}]})});const te=B.buttons.find(k=>k.type==="submit"||k.text.toLowerCase().includes("submit")||k.text.toLowerCase().includes("save")||k.text.toLowerCase().includes("create"));if(te&&R.push({id:crypto.randomUUID(),type:"ui",order:G++,name:`Click ${te.text}`,enabled:!0,continueOnFailure:!1,action:{type:"click"},selectors:[{type:"css",value:te.selector,priority:0,confidence:.9}]}),R.length===0){y.dismiss(g),y.error("No form fields found on this page");return}c(k=>[...k,...R]),U(!0),y.dismiss(g),y.success(`Added ${R.length} steps from ${B.forms.length} forms`)}catch(g){console.error("Collect fields error:",g),y.error(g.message||"Failed to collect fields")}},E=async()=>{if(!(!t||!w))try{const g=y.loading("Generating PDF report..."),$={...t,steps:a};await Bt.generateReport({test:$,dataSets:r,dataSetScenarios:o.length>0?o:void 0,results:w.results,startedAt:Date.now()-w.results.reduce((S,B)=>S+(B.duration||0),0),completedAt:Date.now()}),y.dismiss(g),y.success("PDF report downloaded âœ¨")}catch(g){console.error("PDF generation error:",g),y.error(g.message||"Failed to generate PDF report")}},C=async()=>{if(t)try{await Y.update(n,{steps:a,dataSource:{type:p?"ai-generated":"manual",data:r}}),i({...t,steps:a,dataSource:{type:p?"ai-generated":"manual",data:r}}),U(!1),y.success("Test saved")}catch{y.error("Failed to save test")}},V=async()=>{var g,$;if(a.length===0){y.error("Add at least one step before running");return}u(!0),T({currentStep:0,total:a.length,currentDataSet:0,totalDataSets:r.length,currentStepId:null,results:[]});try{const[S]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(S!=null&&S.id))throw new Error("No active tab found");const B=async()=>{try{await chrome.tabs.sendMessage(S.id,{type:"ping"})}catch{await chrome.scripting.executeScript({target:{tabId:S.id},files:["content.js"]}),await new Promise(R=>setTimeout(R,300))}};for(let R=0;R<r.length;R++){const G=r[R];if(T(k=>k&&{...k,currentDataSet:R}),t!=null&&t.url&&t.url!=="https://"){let k=t.url;Object.entries(G).forEach(([N,L])=>{k=k.replace(new RegExp(`\\{\\{${N}\\}\\}`,"g"),L)}),await chrome.tabs.update(S.id,{url:k}),await new Promise(N=>setTimeout(N,2500)),await B()}const te=k=>{k.type==="playback:step-start"&&T(N=>N?{...N,currentStepId:k.stepId,currentStep:k.index}:null)};chrome.runtime.onMessage.addListener(te);try{let k=[];for(let N=0;N<a.length;N++){const L=a[N];if(L.action.type==="navigate"||L.action.type==="waitTime"){if(k.length>0){try{const D=await chrome.tabs.sendMessage(S.id,{type:"playback:execute",steps:k,variables:G,timeout:3e4});(g=D==null?void 0:D.result)!=null&&g.stepResults&&D.result.stepResults.forEach(Z=>{T(X=>X?{...X,results:[...X.results,{dataSetIndex:R,...Z}]}:null)})}catch(D){throw console.error("Error executing steps before navigation:",D),new Error(`Step execution failed: ${D instanceof Error?D.message:String(D)}`)}k=[]}T(D=>D?{...D,currentStepId:L.id,currentStep:N}:null);try{const D=Date.now();if(L.action.type==="navigate"){let re=L.action.url;Object.entries(G).forEach(([oe,se])=>{re=re.replace(new RegExp(`\\{\\{${oe}\\}\\}`,"g"),se)}),await chrome.tabs.update(S.id,{url:re}),await new Promise(oe=>{let se=!1;const _e=setTimeout(()=>{se||(se=!0,oe())},8e3),xe=(Ve,qe)=>{Ve===S.id&&qe.status==="complete"&&!se&&(se=!0,clearTimeout(_e),chrome.tabs.onUpdated.removeListener(xe),setTimeout(()=>oe(),500))};chrome.tabs.onUpdated.addListener(xe),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(xe)},8500)}),await B()}else if(L.action.type==="waitTime"){const X=L.action;await new Promise(re=>setTimeout(re,X.duration))}const Z=Date.now()-D;T(X=>X?{...X,currentStepId:null,results:[...X.results,{dataSetIndex:R,stepId:L.id,status:"passed",duration:Z}]}:null)}catch(D){throw T(Z=>Z?{...Z,currentStepId:null,results:[...Z.results,{dataSetIndex:R,stepId:L.id,status:"failed",error:`${L.action.type==="navigate"?"Navigation":"Wait"} failed: ${D instanceof Error?D.message:String(D)}`,duration:0}]}:null),D}}else k.push(L)}if(k.length>0)try{const N=await chrome.tabs.sendMessage(S.id,{type:"playback:execute",steps:k,variables:G,timeout:3e4});($=N==null?void 0:N.result)!=null&&$.stepResults&&N.result.stepResults.forEach(L=>{T(D=>D?{...D,results:[...D.results,{dataSetIndex:R,...L}]}:null)})}catch(N){throw console.error("Error executing remaining steps:",N),new Error(`Step execution failed: ${N instanceof Error?N.message:String(N)}`)}}finally{chrome.runtime.onMessage.removeListener(te)}}y.success("Test completed!")}catch(S){console.error("Test execution error:",S),y.error("Test execution failed: "+(S instanceof Error?S.message:"Unknown error"))}finally{u(!1)}};if(!t)return e.jsx("div",{className:"flex items-center justify-center h-full text-dark-500",children:e.jsx(ne,{className:"w-6 h-6 animate-spin"})});const A=(w==null?void 0:w.results.filter(g=>g.status==="passed").length)||0,q=(w==null?void 0:w.results.filter(g=>g.status==="failed").length)||0;return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-b border-dark-800",children:[e.jsx("button",{onClick:s,className:"btn btn-icon btn-sm btn-ghost",children:e.jsx(ut,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{className:"text-lg font-medium text-dark-100 truncate",children:t.name}),e.jsx("p",{className:"text-xs text-dark-500 truncate",children:t.url})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[f==="steps"&&!h&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:_,className:"btn btn-sm btn-ghost text-cyan-400 hover:bg-cyan-400/10",title:"Scan page and collect all form fields",children:[e.jsx(mt,{className:"w-4 h-4"}),"Collect Fields"]}),e.jsxs("button",{onClick:F,disabled:J,className:"btn btn-sm btn-ghost text-purple-400 hover:bg-purple-400/10",title:"AI analyze page and suggest test steps",children:[J?e.jsx(ne,{className:"w-4 h-4 animate-spin"}):e.jsx(ze,{className:"w-4 h-4"}),"AI Analyze"]})]}),a.length>0&&!h&&e.jsxs("button",{onClick:()=>Q(!0),className:"btn btn-sm btn-ghost text-orange-400 hover:bg-orange-400/10",title:"Export test to Playwright, Cypress, or Selenium",children:[e.jsx(Ue,{className:"w-4 h-4"}),"Export"]}),w&&!h&&e.jsxs("button",{onClick:E,className:"btn btn-sm btn-ghost text-blue-400 hover:bg-blue-400/10",title:"Download PDF test report",children:[e.jsx(ht,{className:"w-4 h-4"}),"Report"]}),W&&e.jsxs("button",{onClick:C,className:"btn btn-sm btn-ghost",children:[e.jsx(De,{className:"w-4 h-4"}),"Save"]}),e.jsx("button",{onClick:V,disabled:h,className:"btn btn-sm btn-primary",children:h?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-4 h-4 animate-spin"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4"}),"Run Test"]})})]})]}),w&&e.jsxs("div",{className:"px-4 py-2 bg-dark-850 border-b border-dark-800",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-dark-400 mb-1",children:[e.jsxs("span",{children:["Data Set ",w.currentDataSet+1,"/",w.totalDataSets]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"flex items-center gap-1 text-green-400",children:[e.jsx(pe,{className:"w-3 h-3"})," ",A]}),e.jsxs("span",{className:"flex items-center gap-1 text-red-400",children:[e.jsx(he,{className:"w-3 h-3"})," ",q]})]})]}),e.jsx("div",{className:"h-1 bg-dark-700 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-accent transition-all",style:{width:`${(w.currentDataSet*a.length+w.results.length)/(w.totalDataSets*a.length)*100}%`}})})]}),e.jsxs("div",{className:"flex border-b border-dark-800",children:[e.jsxs("button",{onClick:()=>l("steps"),className:z("flex-1 flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium transition-colors",f==="steps"?"text-accent border-b-2 border-accent":"text-dark-400 hover:text-dark-200"),children:[e.jsx(pt,{className:"w-4 h-4"}),"Steps (",a.length,")"]}),e.jsxs("button",{onClick:()=>l("data"),className:z("flex-1 flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium transition-colors",f==="data"?"text-accent border-b-2 border-accent":"text-dark-400 hover:text-dark-200"),children:[e.jsx(xt,{className:"w-4 h-4"}),"Data (",r.length," sets)"]})]}),e.jsx("div",{className:"flex-1 overflow-auto p-4",children:f==="steps"?e.jsx(Lt,{steps:a,onStepsChange:O,currentStepId:w==null?void 0:w.currentStepId,stepResults:w==null?void 0:w.results}):e.jsx(Ot,{dataSets:r,onDataSetsChange:H,onGenerateWithAI:b,onGenerateScenarioData:M,dataSetScenarios:o})}),e.jsx(Ut,{isOpen:P,onClose:()=>Q(!1),test:{...t,steps:a},dataSets:r})]})}const _t={passed:pe,failed:he,running:Ne,error:me,stopped:me},Vt={passed:"text-status-pass",failed:"text-status-fail",running:"text-status-running",error:"text-status-fail",stopped:"text-status-pending"};function qt(){const[n,s]=v.useState([]),[t,i]=v.useState(!0);return v.useEffect(()=>{Ct.getRecent(50).then(a=>{s(a),i(!1)})},[]),t?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin w-6 h-6 border-2 border-accent border-t-transparent rounded-full"})}):n.length===0?e.jsxs("div",{className:"text-center py-12 text-dark-500",children:[e.jsx(Ee,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No test results yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Run some tests to see results here"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h2",{className:"text-sm font-medium text-dark-400 uppercase tracking-wider",children:["Recent Results (",n.length,")"]}),e.jsx("div",{className:"space-y-2",children:n.map(a=>{const c=_t[a.status],r=Vt[a.status];return e.jsxs("div",{className:"card p-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(c,{className:z("w-5 h-5",r)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-dark-100",children:"Test Run"}),e.jsx("span",{className:z("text-xs px-2 py-0.5 rounded-full",r,"bg-current/10"),children:a.status})]}),e.jsx("div",{className:"text-xs text-dark-500 mt-1",children:new Date(a.startedAt).toLocaleString()})]}),e.jsxs("div",{className:"text-right text-sm",children:[e.jsxs("div",{className:"text-dark-300",children:[a.summary.passedSteps,"/",a.summary.totalSteps," passed"]}),e.jsxs("div",{className:"text-xs text-dark-500",children:[(a.summary.duration/1e3).toFixed(1),"s"]})]})]}),a.summary.failedSteps>0&&e.jsx("div",{className:"mt-2 pt-2 border-t border-dark-700",children:e.jsxs("div",{className:"text-xs text-status-fail",children:[a.summary.failedSteps," step",a.summary.failedSteps!==1?"s":""," failed"]})})]},a.id)})})]})}function Gt(){const{settings:n,refreshSettings:s}=We(),[t,i]=v.useState(""),[a,c]=v.useState(!1),[r,d]=v.useState((n==null?void 0:n.parallelLimit)||2),o=async()=>{if(!t.trim()){y.error("Please enter an API key");return}try{await ce.setOpenAIKey(t),await s(),i(""),y.success("API key saved")}catch{y.error("Failed to save API key")}},m=async()=>{if(confirm("Remove the OpenAI API key?"))try{await ce.clearOpenAIKey(),await s(),y.success("API key removed")}catch{y.error("Failed to remove API key")}},p=async()=>{try{await ce.setParallelLimit(r),await s(),y.success("Settings saved")}catch{y.error("Failed to save settings")}},x=async()=>{if(confirm("This will delete ALL data including tests, results, and settings. This cannot be undone. Continue?"))try{await I.delete(),await I.open(),window.location.reload()}catch{y.error("Failed to clear data")}};return e.jsxs("div",{className:"space-y-6 max-w-lg",children:[e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("h3",{className:"font-medium text-dark-100 flex items-center gap-2",children:[e.jsx(gt,{className:"w-4 h-4"}),"AI Integration"]})}),e.jsxs("div",{className:"card-body space-y-4",children:[e.jsx("p",{className:"text-sm text-dark-400",children:"Add your OpenAI API key to enable AI-powered test data generation and self-healing selectors."}),n!=null&&n.openaiApiKey?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 px-3 py-2 bg-dark-900 rounded-lg text-dark-400 text-sm",children:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"}),e.jsx("button",{onClick:m,className:"btn btn-sm btn-ghost text-red-400",children:e.jsx(ee,{className:"w-4 h-4"})})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:a?"text":"password",placeholder:"sk-...",value:t,onChange:f=>i(f.target.value),className:"input"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:o,className:"btn btn-sm btn-primary",children:"Save API Key"}),e.jsx("button",{onClick:()=>c(!a),className:"btn btn-sm btn-ghost",children:a?"Hide":"Show"})]})]})]})]}),e.jsxs("section",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("h3",{className:"font-medium text-dark-100 flex items-center gap-2",children:[e.jsx(ft,{className:"w-4 h-4"}),"Execution Settings"]})}),e.jsx("div",{className:"card-body space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-dark-400 mb-2",children:"Parallel Test Limit"}),e.jsx("p",{className:"text-xs text-dark-500 mb-2",children:"Maximum number of tests to run simultaneously"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",min:"1",max:"10",value:r,onChange:f=>d(parseInt(f.target.value)||1),className:"input w-20"}),e.jsx("button",{onClick:p,className:"btn btn-sm btn-secondary",children:"Save"})]})]})})]}),e.jsxs("section",{className:"card border-red-900/50",children:[e.jsx("div",{className:"card-header border-red-900/50",children:e.jsx("h3",{className:"font-medium text-red-400",children:"Danger Zone"})}),e.jsxs("div",{className:"card-body",children:[e.jsx("p",{className:"text-sm text-dark-400 mb-4",children:"Permanently delete all data including test suites, tests, and results."}),e.jsxs("button",{onClick:x,className:"btn btn-sm btn-danger",children:[e.jsx(ee,{className:"w-4 h-4"}),"Clear All Data"]})]})]}),e.jsx("section",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"flex items-center gap-2 text-dark-400",children:[e.jsx(yt,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"QAerx v0.1.0"})]}),e.jsx("p",{className:"text-xs text-dark-500 mt-2",children:"Automation testing with AI-powered test data generation"})]})})]})}function Kt({currentView:n,selectedSuiteId:s,selectedTestId:t,onSelectSuite:i,onSelectTest:a}){return n==="tests"&&t?e.jsx("main",{className:"flex-1 overflow-hidden",children:e.jsx(Wt,{testId:t,onBack:()=>a(null)})}):e.jsxs("main",{className:"flex-1 overflow-auto p-4",children:[n==="suites"&&e.jsx(Tt,{selectedSuiteId:s,onSelectSuite:i}),n==="tests"&&e.jsx(Ft,{suiteId:s,selectedTestId:t,onSelectTest:a}),n==="results"&&e.jsx(qt,{}),n==="settings"&&e.jsx(Gt,{})]})}function Yt(){const[n,s]=v.useState("suites"),[t,i]=v.useState(null),[a,c]=v.useState(null);return e.jsxs(It,{children:[e.jsxs("div",{className:"flex h-screen bg-dark-900",children:[e.jsx(jt,{currentView:n,onViewChange:s}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx($t,{currentView:n,selectedSuiteId:t,selectedTestId:a}),e.jsx(Kt,{currentView:n,selectedSuiteId:t,selectedTestId:a,onSelectSuite:i,onSelectTest:c})]})]}),e.jsx(bt,{position:"bottom-right",toastOptions:{className:"bg-dark-800 text-dark-100 border border-dark-600",duration:3e3}})]})}wt.createRoot(document.getElementById("root")).render(e.jsx(vt.StrictMode,{children:e.jsx(Yt,{})}));
