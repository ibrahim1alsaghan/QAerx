var f=Object.defineProperty;var g=(a,e,t)=>e in a?f(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var o=(a,e,t)=>g(a,typeof e!="symbol"?e+"":e,t);import{v as m}from"./chunks/v4.BKT09osN.js";class y{constructor(e){o(this,"handler");o(this,"isAttached",!1);o(this,"boundHandlers",new Map);this.handler=e}attach(){if(this.isAttached)return;const e=["click","dblclick","input","change","keydown","scroll"];for(const t of e){const s=this.createHandler(t);this.boundHandlers.set(t,s),document.addEventListener(t,s,{capture:!0,passive:!0})}this.isAttached=!0}detach(){if(this.isAttached){for(const[e,t]of this.boundHandlers)document.removeEventListener(e,t,{capture:!0});this.boundHandlers.clear(),this.isAttached=!1}}createHandler(e){return t=>{const s=this.captureEvent(e,t);s&&this.handler(s)}}captureEvent(e,t){const s=t.target;if(!s||!(s instanceof Element)||s.closest("[data-qaerx-extension]"))return null;const r={timestamp:Date.now(),target:s,frameSelector:this.getFrameSelector(s)};switch(e){case"click":case"dblclick":{const n=t;return{...r,type:e,target:s,timestamp:r.timestamp,button:this.getMouseButton(n.button)}}case"input":{const n=s;return"value"in n?{...r,type:"input",target:s,timestamp:r.timestamp,value:n.value}:null}case"change":{const n=s;return n.tagName==="SELECT"?{...r,type:"change",target:s,timestamp:r.timestamp,value:n.value}:n.type==="checkbox"||n.type==="radio"?{...r,type:"change",target:s,timestamp:r.timestamp,checked:n.checked}:null}case"keydown":{const n=t;return this.isSpecialKey(n.key)?{...r,type:"keydown",target:s,timestamp:r.timestamp,key:n.key,modifiers:this.getModifiers(n)}:null}case"scroll":return{...r,type:"scroll",target:s,timestamp:r.timestamp,scrollX:window.scrollX,scrollY:window.scrollY};default:return null}}getMouseButton(e){switch(e){case 0:return"left";case 1:return"middle";case 2:return"right";default:return"left"}}isSpecialKey(e){return["Enter","Tab","Escape","Backspace","Delete","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"].includes(e)}getModifiers(e){const t=[];return e.ctrlKey&&t.push("Ctrl"),e.shiftKey&&t.push("Shift"),e.altKey&&t.push("Alt"),e.metaKey&&t.push("Meta"),t}getFrameSelector(e){const t=e.ownerDocument.defaultView;if(t===window)return;const s=document.querySelectorAll("iframe");for(const r of s)if(r.contentWindow===t){const n=r.id?`#${r.id}`:"",i=r.name?`[name="${r.name}"]`:"";return n?`iframe${n}`:i?`iframe${i}`:`iframe[src="${r.src}"]`}}}class S{generate(e){const t=[];let s=0;const r=e.getAttribute("data-testid");r&&t.push({type:"data-testid",value:`[data-testid="${r}"]`,priority:s++,confidence:.95});const n=e.getAttribute("data-cy");n&&t.push({type:"data-cy",value:`[data-cy="${n}"]`,priority:s++,confidence:.95});const i=e.getAttribute("aria-label");i&&t.push({type:"aria",value:`[aria-label="${i}"]`,priority:s++,confidence:.85});const l=e.getAttribute("role");l&&e.id&&this.isStableId(e.id)&&t.push({type:"aria",value:`[role="${l}"]#${e.id}`,priority:s++,confidence:.8}),e.id&&this.isStableId(e.id)&&t.push({type:"css",value:`#${CSS.escape(e.id)}`,priority:s++,confidence:.85});const c=this.generateSemanticCSS(e);c&&t.push({type:"css",value:c,priority:s++,confidence:.7});const u=this.getUniqueTextContent(e);u&&t.push({type:"text",value:u,priority:s++,confidence:.5});const h=this.generateFullCSSPath(e);return t.push({type:"css",value:h,priority:s++,confidence:.4}),t}isStableId(e){return![/^[a-f0-9]{8}-[a-f0-9]{4}/i,/^:r[0-9]+:/,/^ember\d+$/,/^ng-\d+$/,/^\d+$/,/^[a-z]+_[a-f0-9]{6,}$/i,/^mui-\d+$/,/^headlessui-/].some(s=>s.test(e))}generateSemanticCSS(e){const t=e.tagName.toLowerCase(),s=Array.from(e.classList).filter(i=>this.isSemanticClass(i)).slice(0,2);if(s.length===0)return null;const r=`${t}.${s.join(".")}`;if(document.querySelectorAll(r).length===1)return r;const n=e.parentElement;if(n&&n.tagName!=="BODY"){const i=n.tagName.toLowerCase(),l=Array.from(n.classList).filter(c=>this.isSemanticClass(c)).slice(0,1);if(l.length>0){const c=`${i}.${l[0]} > ${r}`;if(document.querySelectorAll(c).length===1)return c}}return null}isSemanticClass(e){const t=[/^[a-z]{1,2}-\d+$/,/^[a-f0-9]{6,}$/i,/^css-[a-z0-9]+$/i,/^sc-[a-zA-Z]+$/,/^emotion-[0-9]+$/,/^_[a-zA-Z0-9]+$/,/^[a-z]+__[a-z]+--/];return e.length>2&&!t.some(s=>s.test(e))}generateFullCSSPath(e){const t=[];let s=e;for(;s&&s.tagName!=="HTML";){let r=s.tagName.toLowerCase();if(s.id&&this.isStableId(s.id)){r=`#${CSS.escape(s.id)}`,t.unshift(r);break}const n=s.parentElement;if(n){const i=s.tagName,l=n.children,c=[];for(let u=0;u<l.length;u++)l[u].tagName===i&&c.push(l[u]);if(c.length>1){const u=c.indexOf(s)+1;r+=`:nth-of-type(${u})`}t.unshift(r),s=n}else{t.unshift(r);break}}return t.join(" > ")}getUniqueTextContent(e){var r;if(!["BUTTON","A","LABEL","H1","H2","H3","H4","H5","H6"].includes(e.tagName))return null;const s=(r=e.textContent)==null?void 0:r.trim();return!s||s.length<2||s.length>50?null:s}getElementDescription(e){if(e.type==="text")return`"${e.value.substring(0,20)}${e.value.length>20?"...":""}"`;if(e.type==="data-testid"||e.type==="data-cy"){const t=e.value.match(/\[data-(?:testid|cy)="([^"]+)"\]/);return t?t[1]:e.value}if(e.type==="aria"){const t=e.value.match(/\[aria-label="([^"]+)"\]/);return t?t[1]:e.value}return e.type==="css"&&e.value.startsWith("#")?e.value.substring(1):e.value.split(" > ").pop()||e.value}}class b{constructor(){o(this,"SCROLL_DEBOUNCE_MS",300)}filter(e){let t=e;return t=this.dedupeScrolls(t),t=this.collapseInputs(t),t=t.filter(s=>s.type!=="focus"&&s.type!=="blur"),t=t.filter(s=>!this.isExtensionElement(s.target)),t}dedupeScrolls(e){const t=[];let s=null,r=0;for(const n of e)n.type==="scroll"?(s&&n.timestamp-r<this.SCROLL_DEBOUNCE_MS?t[t.length-1]=n:t.push(n),s=n,r=n.timestamp):(t.push(n),s=null);return t}collapseInputs(e){const t=[];let s=[],r=null;const n=()=>{if(s.length>0){const i=s[s.length-1];t.push(i),s=[]}};for(const i of e)i.type==="input"?(r!==i.target&&(n(),r=i.target),s.push(i)):(n(),r=null,t.push(i));return n(),t}isExtensionElement(e){return e.closest("[data-qaerx-extension]")!==null}}function k(a,e){let t;return(...s)=>{clearTimeout(t),t=setTimeout(()=>a(...s),e)}}class v{constructor(){o(this,"session",null);o(this,"eventCapture");o(this,"selectorGenerator");o(this,"actionFilter");o(this,"debouncedProcessEvents");this.eventCapture=new y(this.handleEvent.bind(this)),this.selectorGenerator=new S,this.actionFilter=new b,this.debouncedProcessEvents=k(()=>this.processPendingEvents(),100)}start(e){if(this.session)throw new Error("Recording already in progress");this.session={id:e,startedAt:Date.now(),isPaused:!1,steps:[],pendingEvents:[]},this.eventCapture.attach(),this.sendToBackground({type:"recording:started",sessionId:e})}pause(){this.session&&(this.session.isPaused=!0,this.sendToBackground({type:"recording:paused"}))}resume(){this.session&&(this.session.isPaused=!1,this.sendToBackground({type:"recording:resumed"}))}stop(){if(!this.session)return[];this.eventCapture.detach(),this.processPendingEvents();const e=this.session.steps,t=this.session.id;return this.session=null,this.sendToBackground({type:"recording:stopped",sessionId:t,steps:e}),e}getSteps(){var e;return((e=this.session)==null?void 0:e.steps)||[]}isRecording(){return this.session!==null&&!this.session.isPaused}handleEvent(e){!this.session||this.session.isPaused||(this.session.pendingEvents.push(e),this.debouncedProcessEvents())}processPendingEvents(){if(!this.session||this.session.pendingEvents.length===0)return;const e=this.session.pendingEvents;this.session.pendingEvents=[];const t=this.actionFilter.filter(e);for(const s of t){const r=this.createStep(s);r&&(this.session.steps.push(r),this.sendToBackground({type:"recording:step-added",step:r}))}}createStep(e){const t=this.selectorGenerator.generate(e.target);if(t.length===0)return console.warn("Could not generate selectors for element:",e.target),null;const s=this.mapEventToAction(e);return s?{id:m(),type:"ui",order:this.session.steps.length,name:this.generateStepName(s,t[0]),enabled:!0,continueOnFailure:!1,action:s,selectors:e.frameSelector?t.map(n=>({...n,frameSelector:e.frameSelector})):t}:null}mapEventToAction(e){switch(e.type){case"click":return{type:"click",button:e.button};case"dblclick":return{type:"dblclick"};case"input":return{type:"type",text:e.value||""};case"change":return e.target.tagName==="SELECT"?{type:"select",value:e.value||""}:e.target instanceof HTMLInputElement&&(e.target.type==="checkbox"||e.target.type==="radio")?e.checked?{type:"check"}:{type:"uncheck"}:null;case"scroll":return{type:"scroll",x:e.scrollX,y:e.scrollY};case"keydown":return e.key?{type:"press",key:e.key,modifiers:e.modifiers}:null;default:return null}}generateStepName(e,t){var r;const s=this.selectorGenerator.getElementDescription(t);switch(e.type){case"click":return`Click ${s}`;case"dblclick":return`Double-click ${s}`;case"type":return`Type "${e.text.length>20?e.text.substring(0,20)+"...":e.text}" into ${s}`;case"select":return`Select "${e.value}" in ${s}`;case"check":return`Check ${s}`;case"uncheck":return`Uncheck ${s}`;case"scroll":return"Scroll page";case"press":const i=((r=e.modifiers)==null?void 0:r.join("+"))||"";return`Press ${i?i+"+":""}${e.key}`;default:return`${e.type} on ${s}`}}sendToBackground(e){try{chrome.runtime.sendMessage(e)}catch(t){console.error("Failed to send message to background:",t)}}}let p=null;function E(){return p||(p=new v),p}const d=E();chrome.runtime.onMessage.addListener((a,e,t)=>{switch(a.type){case"recording:start":d.start(a.sessionId),t({success:!0});break;case"recording:stop":const s=d.stop();t({success:!0,steps:s});break;case"recording:pause":d.pause(),t({success:!0});break;case"recording:resume":d.resume(),t({success:!0});break;case"recording:status":t({isRecording:d.isRecording(),steps:d.getSteps()});break;default:t({error:"Unknown message type"})}return!0});chrome.runtime.sendMessage({type:"content-script:ready"});console.log("[QAerx] Content script initialized");
