var y=Object.defineProperty;var b=(a,e,t)=>e in a?y(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var u=(a,e,t)=>b(a,typeof e!="symbol"?e+"":e,t);class w{constructor(e){u(this,"handler");u(this,"isAttached",!1);u(this,"boundHandlers",new Map);this.handler=e}attach(){if(this.isAttached)return;const e=["click","dblclick","input","change","keydown","scroll"];for(const t of e){const n=this.createHandler(t);this.boundHandlers.set(t,n),document.addEventListener(t,n,{capture:!0,passive:!0})}this.isAttached=!0}detach(){if(this.isAttached){for(const[e,t]of this.boundHandlers)document.removeEventListener(e,t,{capture:!0});this.boundHandlers.clear(),this.isAttached=!1}}createHandler(e){return t=>{const n=this.captureEvent(e,t);n&&this.handler(n)}}captureEvent(e,t){const n=t.target;if(!n||!(n instanceof Element)||n.closest("[data-qaerx-extension]"))return null;const s={timestamp:Date.now(),target:n,frameSelector:this.getFrameSelector(n)};switch(e){case"click":case"dblclick":{const r=t;return{...s,type:e,target:n,timestamp:s.timestamp,button:this.getMouseButton(r.button)}}case"input":{const r=n;return"value"in r?{...s,type:"input",target:n,timestamp:s.timestamp,value:r.value}:null}case"change":{const r=n;return r.tagName==="SELECT"?{...s,type:"change",target:n,timestamp:s.timestamp,value:r.value}:r.type==="checkbox"||r.type==="radio"?{...s,type:"change",target:n,timestamp:s.timestamp,checked:r.checked}:null}case"keydown":{const r=t;return this.isSpecialKey(r.key)?{...s,type:"keydown",target:n,timestamp:s.timestamp,key:r.key,modifiers:this.getModifiers(r)}:null}case"scroll":return{...s,type:"scroll",target:n,timestamp:s.timestamp,scrollX:window.scrollX,scrollY:window.scrollY};default:return null}}getMouseButton(e){switch(e){case 0:return"left";case 1:return"middle";case 2:return"right";default:return"left"}}isSpecialKey(e){return["Enter","Tab","Escape","Backspace","Delete","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"].includes(e)}getModifiers(e){const t=[];return e.ctrlKey&&t.push("Ctrl"),e.shiftKey&&t.push("Shift"),e.altKey&&t.push("Alt"),e.metaKey&&t.push("Meta"),t}getFrameSelector(e){const t=e.ownerDocument.defaultView;if(t===window)return;const n=document.querySelectorAll("iframe");for(const s of n)if(s.contentWindow===t){const r=s.id?`#${s.id}`:"",i=s.name?`[name="${s.name}"]`:"";return r?`iframe${r}`:i?`iframe${i}`:`iframe[src="${s.src}"]`}}}class k{generate(e){const t=[];let n=0;const s=e.getAttribute("data-testid");s&&t.push({type:"data-testid",value:`[data-testid="${s}"]`,priority:n++,confidence:.95});const r=e.getAttribute("data-cy");r&&t.push({type:"data-cy",value:`[data-cy="${r}"]`,priority:n++,confidence:.95});const i=e.getAttribute("aria-label");i&&t.push({type:"aria",value:`[aria-label="${i}"]`,priority:n++,confidence:.85});const c=e.getAttribute("role");c&&e.id&&this.isStableId(e.id)&&t.push({type:"aria",value:`[role="${c}"]#${e.id}`,priority:n++,confidence:.8}),e.id&&this.isStableId(e.id)&&t.push({type:"css",value:`#${CSS.escape(e.id)}`,priority:n++,confidence:.85});const o=this.generateSemanticCSS(e);o&&t.push({type:"css",value:o,priority:n++,confidence:.7});const l=this.getUniqueTextContent(e);l&&t.push({type:"text",value:l,priority:n++,confidence:.5});const p=this.generateFullCSSPath(e);return t.push({type:"css",value:p,priority:n++,confidence:.4}),t}isStableId(e){return![/^[a-f0-9]{8}-[a-f0-9]{4}/i,/^:r[0-9]+:/,/^ember\d+$/,/^ng-\d+$/,/^\d+$/,/^[a-z]+_[a-f0-9]{6,}$/i,/^mui-\d+$/,/^headlessui-/].some(n=>n.test(e))}generateSemanticCSS(e){const t=e.tagName.toLowerCase(),n=Array.from(e.classList).filter(i=>this.isSemanticClass(i)).slice(0,2);if(n.length===0)return null;const s=`${t}.${n.join(".")}`;if(document.querySelectorAll(s).length===1)return s;const r=e.parentElement;if(r&&r.tagName!=="BODY"){const i=r.tagName.toLowerCase(),c=Array.from(r.classList).filter(o=>this.isSemanticClass(o)).slice(0,1);if(c.length>0){const o=`${i}.${c[0]} > ${s}`;if(document.querySelectorAll(o).length===1)return o}}return null}isSemanticClass(e){const t=[/^[a-z]{1,2}-\d+$/,/^[a-f0-9]{6,}$/i,/^css-[a-z0-9]+$/i,/^sc-[a-zA-Z]+$/,/^emotion-[0-9]+$/,/^_[a-zA-Z0-9]+$/,/^[a-z]+__[a-z]+--/];return e.length>2&&!t.some(n=>n.test(e))}generateFullCSSPath(e){const t=[];let n=e;for(;n&&n.tagName!=="HTML";){let s=n.tagName.toLowerCase();if(n.id&&this.isStableId(n.id)){s=`#${CSS.escape(n.id)}`,t.unshift(s);break}const r=n.parentElement;if(r){const i=n.tagName,c=r.children,o=[];for(let l=0;l<c.length;l++)c[l].tagName===i&&o.push(c[l]);if(o.length>1){const l=o.indexOf(n)+1;s+=`:nth-of-type(${l})`}t.unshift(s),n=r}else{t.unshift(s);break}}return t.join(" > ")}getUniqueTextContent(e){var s;if(!["BUTTON","A","LABEL","H1","H2","H3","H4","H5","H6"].includes(e.tagName))return null;const n=(s=e.textContent)==null?void 0:s.trim();return!n||n.length<2||n.length>50?null:n}getElementDescription(e){if(e.type==="text")return`"${e.value.substring(0,20)}${e.value.length>20?"...":""}"`;if(e.type==="data-testid"||e.type==="data-cy"){const t=e.value.match(/\[data-(?:testid|cy)="([^"]+)"\]/);return t?t[1]:e.value}if(e.type==="aria"){const t=e.value.match(/\[aria-label="([^"]+)"\]/);return t?t[1]:e.value}return e.type==="css"&&e.value.startsWith("#")?e.value.substring(1):e.value.split(" > ").pop()||e.value}}class E{constructor(){u(this,"SCROLL_DEBOUNCE_MS",300)}filter(e){let t=e;return t=this.dedupeScrolls(t),t=this.collapseInputs(t),t=t.filter(n=>n.type!=="focus"&&n.type!=="blur"),t=t.filter(n=>!this.isExtensionElement(n.target)),t}dedupeScrolls(e){const t=[];let n=null,s=0;for(const r of e)r.type==="scroll"?(n&&r.timestamp-s<this.SCROLL_DEBOUNCE_MS?t[t.length-1]=r:t.push(r),n=r,s=r.timestamp):(t.push(r),n=null);return t}collapseInputs(e){const t=[];let n=[],s=null;const r=()=>{if(n.length>0){const i=n[n.length-1];t.push(i),n=[]}};for(const i of e)i.type==="input"?(s!==i.target&&(r(),s=i.target),n.push(i)):(r(),s=null,t.push(i));return r(),t}isExtensionElement(e){return e.closest("[data-qaerx-extension]")!==null}}const v=()=>crypto.randomUUID();function S(a,e){let t;return(...n)=>{clearTimeout(t),t=setTimeout(()=>a(...n),e)}}class x{constructor(){u(this,"session",null);u(this,"eventCapture");u(this,"selectorGenerator");u(this,"actionFilter");u(this,"debouncedProcessEvents");this.eventCapture=new w(this.handleEvent.bind(this)),this.selectorGenerator=new k,this.actionFilter=new E,this.debouncedProcessEvents=S(()=>this.processPendingEvents(),100)}start(e){if(this.session)throw new Error("Recording already in progress");this.session={id:e,startedAt:Date.now(),isPaused:!1,steps:[],pendingEvents:[]},this.eventCapture.attach(),this.sendToBackground({type:"recording:started",sessionId:e})}pause(){this.session&&(this.session.isPaused=!0,this.sendToBackground({type:"recording:paused"}))}resume(){this.session&&(this.session.isPaused=!1,this.sendToBackground({type:"recording:resumed"}))}stop(){if(!this.session)return[];this.eventCapture.detach(),this.processPendingEvents();const e=this.session.steps,t=this.session.id;return this.session=null,this.sendToBackground({type:"recording:stopped",sessionId:t,steps:e}),e}getSteps(){var e;return((e=this.session)==null?void 0:e.steps)||[]}isRecording(){return this.session!==null&&!this.session.isPaused}handleEvent(e){!this.session||this.session.isPaused||(this.session.pendingEvents.push(e),this.debouncedProcessEvents())}processPendingEvents(){if(!this.session||this.session.pendingEvents.length===0)return;const e=this.session.pendingEvents;this.session.pendingEvents=[];const t=this.actionFilter.filter(e);for(const n of t){const s=this.createStep(n);s&&(this.session.steps.push(s),this.sendToBackground({type:"recording:step-added",step:s}))}}createStep(e){const t=this.selectorGenerator.generate(e.target);if(t.length===0)return console.warn("Could not generate selectors for element:",e.target),null;const n=this.mapEventToAction(e);return n?{id:v(),type:"ui",order:this.session.steps.length,name:this.generateStepName(n,t[0]),enabled:!0,continueOnFailure:!1,action:n,selectors:e.frameSelector?t.map(r=>({...r,frameSelector:e.frameSelector})):t}:null}mapEventToAction(e){switch(e.type){case"click":return{type:"click",button:e.button};case"dblclick":return{type:"dblclick"};case"input":return{type:"type",text:e.value||""};case"change":return e.target.tagName==="SELECT"?{type:"select",value:e.value||""}:e.target instanceof HTMLInputElement&&(e.target.type==="checkbox"||e.target.type==="radio")?e.checked?{type:"check"}:{type:"uncheck"}:null;case"scroll":return{type:"scroll",x:e.scrollX,y:e.scrollY};case"keydown":return e.key?{type:"press",key:e.key,modifiers:e.modifiers}:null;default:return null}}generateStepName(e,t){var s;const n=this.selectorGenerator.getElementDescription(t);switch(e.type){case"click":return`Click ${n}`;case"dblclick":return`Double-click ${n}`;case"type":return`Type "${e.text.length>20?e.text.substring(0,20)+"...":e.text}" into ${n}`;case"select":return`Select "${e.value}" in ${n}`;case"check":return`Check ${n}`;case"uncheck":return`Uncheck ${n}`;case"scroll":return"Scroll page";case"press":const i=((s=e.modifiers)==null?void 0:s.join("+"))||"";return`Press ${i?i+"+":""}${e.key}`;default:return`${e.type} on ${n}`}}sendToBackground(e){try{chrome.runtime.sendMessage(e)}catch(t){console.error("Failed to send message to background:",t)}}}let f=null;function T(){return f||(f=new x),f}const $=3e4;class C{constructor(){u(this,"shouldStop",!1)}async execute(e,t={}){const{timeout:n=$,variables:s={},onStepStart:r,onStepComplete:i}=t;this.shouldStop=!1;const c={status:"passed",startedAt:Date.now(),completedAt:0,stepResults:[]};for(let o=0;o<e.length&&!this.shouldStop;o++){const l=e[o];if(!l.enabled){c.stepResults.push({stepId:l.id,status:"skipped",duration:0});continue}r==null||r(l,o);const p=Date.now(),h=await this.executeStep(l,n,s);if(h.duration=Date.now()-p,c.stepResults.push(h),i==null||i(l,h),h.status==="failed"&&!l.continueOnFailure){c.status="failed";break}}return c.completedAt=Date.now(),c}stop(){this.shouldStop=!0}async executeStep(e,t,n){try{const s=this.substituteVariables(e.action,n);switch(s.type){case"navigate":await this.navigate(s.url,t);break;case"click":await this.click(e.selectors,t);break;case"dblclick":await this.dblclick(e.selectors,t);break;case"type":await this.type(e.selectors,s.text,t);break;case"select":await this.select(e.selectors,s.value,t);break;case"check":await this.check(e.selectors,!0,t);break;case"uncheck":await this.check(e.selectors,!1,t);break;case"waitForElement":await this.waitForElement(e.selectors,t);break;case"scroll":await this.scroll(s.x||0,s.y||0);break;default:throw new Error(`Unknown action type: ${s.type}`)}return{stepId:e.id,status:"passed",duration:0}}catch(s){return{stepId:e.id,status:"failed",duration:0,error:s instanceof Error?s.message:String(s)}}}substituteVariables(e,t){const n=r=>r.replace(/\{\{(\w+)\}\}/g,(i,c)=>t[c]??`{{${c}}}`),s={...e};return"url"in s&&typeof s.url=="string"&&(s.url=n(s.url)),"text"in s&&typeof s.text=="string"&&(s.text=n(s.text)),"value"in s&&typeof s.value=="string"&&(s.value=n(s.value)),s}async navigate(e,t){window.location.href=e,await this.waitForLoad(t)}async waitForLoad(e){return new Promise((t,n)=>{const s=setTimeout(()=>n(new Error("Page load timeout")),e);if(document.readyState==="complete"){clearTimeout(s),t();return}window.addEventListener("load",()=>{clearTimeout(s),t()},{once:!0})})}async findElement(e,t){const n=Date.now();for(;Date.now()-n<t;){for(const s of e)try{let r=null;switch(s.type){case"css":case"data-testid":case"data-cy":case"aria":r=document.querySelector(s.value);break;case"xpath":r=document.evaluate(s.value,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;break;case"text":r=this.findByText(s.value);break}if(r&&this.isElementVisible(r))return r}catch{}await this.sleep(100)}throw new Error(`Element not found with selectors: ${e.map(s=>s.value).join(", ")}`)}findByText(e){var s;const t=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT);let n;for(;n=t.nextNode();){const r=n;if(((s=r.textContent)==null?void 0:s.trim())===e)return r}return null}isElementVisible(e){const t=e.getBoundingClientRect(),n=window.getComputedStyle(e);return t.width>0&&t.height>0&&n.visibility!=="hidden"&&n.display!=="none"&&n.opacity!=="0"}async click(e,t){const n=await this.findElement(e,t);this.scrollIntoView(n),n.click()}async dblclick(e,t){const n=await this.findElement(e,t);this.scrollIntoView(n),n.dispatchEvent(new MouseEvent("dblclick",{bubbles:!0}))}async type(e,t,n){const s=await this.findElement(e,n);if(this.scrollIntoView(s),s instanceof HTMLInputElement||s instanceof HTMLTextAreaElement){s.focus(),s.value="";for(const r of t)s.value+=r,s.dispatchEvent(new Event("input",{bubbles:!0})),await this.sleep(10);s.dispatchEvent(new Event("change",{bubbles:!0}))}else throw new Error("Element is not an input or textarea")}async select(e,t,n){const s=await this.findElement(e,n);if(s instanceof HTMLSelectElement)s.value=t,s.dispatchEvent(new Event("change",{bubbles:!0}));else throw new Error("Element is not a select")}async check(e,t,n){const s=await this.findElement(e,n);if(s instanceof HTMLInputElement&&(s.type==="checkbox"||s.type==="radio"))s.checked!==t&&s.click();else throw new Error("Element is not a checkbox or radio")}async waitForElement(e,t){await this.findElement(e,t)}async scroll(e,t){window.scrollTo(e,t)}scrollIntoView(e){e.scrollIntoView({behavior:"smooth",block:"center"})}sleep(e){return new Promise(t=>setTimeout(t,e))}}let m=null;function A(){return m||(m=new C),m}const d=T(),g=A();chrome.runtime.onMessage.addListener((a,e,t)=>{switch(a.type){case"ping":t({success:!0,loaded:!0});break;case"recording:start":d.start(a.sessionId),t({success:!0});break;case"recording:stop":const n=d.stop();t({success:!0,steps:n});break;case"recording:pause":d.pause(),t({success:!0});break;case"recording:resume":d.resume(),t({success:!0});break;case"recording:status":t({isRecording:d.isRecording(),steps:d.getSteps()});break;case"playback:execute":return g.execute(a.steps,{timeout:a.timeout||3e4,variables:a.variables||{},onStepStart:(s,r)=>{chrome.runtime.sendMessage({type:"playback:step-start",stepId:s.id,index:r}).catch(()=>{})},onStepComplete:(s,r)=>{chrome.runtime.sendMessage({type:"playback:step-complete",stepId:s.id,result:r}).catch(()=>{})}}).then(s=>{t({success:!0,result:s})}).catch(s=>{t({success:!1,error:String(s)})}),!0;case"playback:stop":g.stop(),t({success:!0});break;default:t({error:"Unknown message type"})}return!0});chrome.runtime.sendMessage({type:"content-script:ready"}).catch(()=>{});console.log("[QAerx] Content script initialized");
